<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è¿›é”€å­˜æ™ºèƒ½åº“å­˜åˆ†ææŠ¥è¡¨ - å¤šç»´åº¦å¯è§†åŒ–</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" />
  <style>
    body {
      font-family: 'Roboto', 'Microsoft YaHei', Arial, sans-serif;
      background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 85%);
      margin: 0;
      padding: 0 0 80px 0;
      position: relative;
    }
    body::before {
      content: '';
      position: fixed;
      top: 0;
      right: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg,
        rgba(99, 102, 241, 0.03) 0%,
        rgba(168, 85, 247, 0.02) 25%,
        transparent 50%,
        rgba(59, 130, 246, 0.02) 75%,
        rgba(14, 165, 233, 0.03) 100%
      );
      pointer-events: none;
      z-index: 0;
    }
    .container {
      position: relative;
      z-index: 1;
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 16px 32px 16px;
    }
    .header {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(52, 55, 75, 0.09);
      padding: 36px 20px 24px 20px;
      margin-bottom: 28px;
      text-align: center;
      position: relative;
    }
    .header-title {
      font-size: 2.2rem;
      font-weight: 900;
      letter-spacing: 2px;
      color: #205295;
    }
    .header-subtitle {
      color: #64748b;
      font-size: 1rem;
      margin-top: 10px;
      letter-spacing: 0.5px;
    }
    .upload-box {
      background: #f7fbff;
      border: 2px dashed #2779bd;
      border-radius: 12px;
      text-align: center;
      padding: 54px 18px;
      margin-bottom: 26px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 1.1rem;
      color: #205295;
      position: relative;
    }
    .upload-box:hover {
      border-color: #1e5a8e;
      background: #eff8ff;
    }
    .upload-box.dragover {
      border-color: #f87171;
      background: #fef2f2;
      color: #b91c1c;
    }
    .file-info {
      margin-top: 18px;
      color: #64748b;
      font-size: 0.97rem;
    }
    .panel {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 18px rgba(56, 56, 76, 0.07);
      padding: 30px 20px 24px 20px;
      margin-bottom: 24px;
    }
    .panel-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: #0d223a;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .panel-title span {
      font-size: 1.5em;
    }
    .stats-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 12px;
    }
    .stat-card {
      background: linear-gradient(105deg, #e0f2fe 80%, #fff 100%);
      border-radius: 12px;
      text-align: center;
      padding: 24px 16px 18px 16px;
      box-shadow: 0 2px 8px 0 #e2e8f0;
      transition: transform 0.2s;
    }
    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px 0 #cbd5e1;
    }
    .stat-label {
      color: #64748b;
      font-size: 0.95em;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .stat-value {
      font-size: 2em;
      color: #205295;
      font-weight: bold;
    }
    .stat-value.warning {
      color: #ea580c;
    }
    /* åŸå§‹æ˜ç»†åˆ†ç±»æ±‡æ€»å—ç´§å‡‘æ ·å¼ */
    #category-summary .stat-card {
      padding: 14px 12px 12px 12px;
      border-radius: 10px;
      box-shadow: 0 1px 4px 0 #e5e7eb;
      background: linear-gradient(105deg, #eaf2fe 85%, #fff 100%);
    }
    #category-summary .stat-label {
      font-size: 0.85em;
      margin-bottom: 6px;
    }
    #category-summary .stat-value {
      font-size: 1.5em;
    }
    .category-tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 18px;
      flex-wrap: wrap;
    }
    .category-tab {
      padding: 10px 28px;
      border-radius: 20px;
      font-weight: 600;
      background: #eff6ff;
      color: #2563eb;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      font-size: 0.95em;
    }
    .category-tab:hover {
      background: #dbeafe;
    }
    .category-tab.active {
      background: #2563eb;
      color: #fff;
      box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
    }
    /* æ— ç¼èšåˆå¡ç‰‡æ ·å¼ä¸åˆ†ç±»æ±‡æ€»ä¸€è‡´ */
    #seamless-aggregates {
      display: grid;
      grid-template-columns: repeat(5, minmax(160px, 1fr));
      gap: 12px;
      align-items: stretch;
    }
    #seamless-aggregates .stat-card {
      padding: 14px 12px 12px 12px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
      background: linear-gradient(105deg, #eaf2fe 85%, #fff 100%);
      min-height: 86px;
    }
    #seamless-aggregates .stat-label { font-size: 0.85em; margin-bottom: 6px; }
    #seamless-aggregates .stat-value { font-size: 1.5em; }
    .chart-box {
      margin: 0 0 12px 0;
      padding: 0;
      min-height: 320px;
      position: relative;
    }
    .table-wrapper {
      overflow-x: auto;
      border-radius: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #f9fafb;
      border-radius: 8px;
      font-size: 0.9em;
    }
    /* ä»…ä½åº“å­˜è¡¨ä½¿ç”¨å›ºå®šå¸ƒå±€ä»¥å‹ç¼©åˆ—å®½ */
    #lowStockTable { table-layout: fixed; }
    #lowStockTable th:nth-child(1), #lowStockTable td:nth-child(1) { width: 60px; }
    #lowStockTable th:nth-child(2), #lowStockTable td:nth-child(2) { width: 70px; }
    #lowStockTable th:nth-child(3), #lowStockTable td:nth-child(3) { width: 120px; }
    #lowStockTable th:nth-child(4), #lowStockTable td:nth-child(4) { width: 60px; }
    #lowStockTable th:nth-child(5), #lowStockTable td:nth-child(5) { width: auto; }
    #lowStockTable th:nth-child(6), #lowStockTable td:nth-child(6) { width: 90px; }
    #lowStockTable th:nth-child(7), #lowStockTable td:nth-child(7) { width: 80px; }
    #lowStockTable th:nth-child(8), #lowStockTable td:nth-child(8) { width: 90px; }
    #lowStockTable th:nth-child(9), #lowStockTable td:nth-child(9) { width: 80px; }
    #lowStockTable th:nth-child(10), #lowStockTable td:nth-child(10) { width: 90px; }
    #lowStockTable th:nth-child(11), #lowStockTable td:nth-child(11) { width: 90px; }
    /* ç´§å‡‘å¯†åº¦æ ·å¼ */
    #lowStockTable.dense th { padding: 6px; font-size: 0.85em; }
    #lowStockTable.dense td { padding: 4px 6px; font-size: 0.82em; }
    #lowStockTable.dense .product-thumb { width: 36px; height: 36px; }
    #lowStockTable td.name, #lowStockTable td.sku, #lowStockTable td.cat { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    thead {
      background: linear-gradient(90deg, #e0e7ef 60%, #fff 100%);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    th {
      padding: 12px 8px;
      text-align: center;
      color: #205295;
      font-weight: 700;
      letter-spacing: 0.5px;
      border-bottom: 2px solid #cbd5e1;
    }
    td {
      padding: 10px 8px;
      text-align: center;
      border-bottom: 1px solid #e5e7eb;
    }
    tr:hover {
      background: #e8eaf6;
    }
    tr.lowstock {
      background: #fef3c7 !important;
    }
    tr.lowstock:hover {
      background: #fde68a !important;
    }
    .warn-icon {
      color: #ea580c;
      font-size: 1.1em;
      vertical-align: middle;
    }
    .top-section {
      margin-bottom: 32px;
    }
    .top-category-title {
      font-size: 1.1em;
      font-weight: 700;
      color: #1e40af;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 2px solid #dbeafe;
    }
    .top-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
      margin-bottom: 8px;
      overflow-x: auto;
      padding-bottom: 8px;
    }
    .top-list-item {
      background: linear-gradient(135deg, #fffaf0 0%, #fffbeb 100%);
      border-radius: 10px;
      padding: 12px 10px;
      text-align: center;
      border: 1px solid #fde68a;
      transition: transform 0.2s;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
      max-height: 220px;
      overflow: hidden;
    }
    .top-list-item:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 16px rgba(252, 211, 77, 0.3);
    }
    .top-rank {
      display: inline-block;
      width: 28px;
      height: 28px;
      line-height: 28px;
      border-radius: 50%;
      background: #f59e0b;
      color: white;
      font-weight: bold;
      font-size: 0.9em;
      margin-bottom: 8px;
    }
    .top-sku {
      font-size: 0.9em;
      color: #92400e;
      font-weight: bold;
      margin: 6px 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .top-size {
      color: #b45309;
      font-size: 0.78em;
      margin-bottom: 6px;
    }
    .top-name {
      color: #78716c;
      font-size: 0.75em;
      margin-bottom: 8px;
      min-height: 24px;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }
    .top-stat {
      display: flex;
      justify-content: space-around;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #fde68a;
    }
    .top-stat-item {
      text-align: center;
    }
    .top-stat-label {
      font-size: 0.75em;
      color: #92400e;
      margin-bottom: 3px;
    }
    .top-stat-value {
      font-size: 1em;
      font-weight: bold;
      color: #b45309;
    }
    .footer {
      text-align: center;
      color: #8ca3af;
      margin-top: 40px;
      font-size: 0.95em;
    }
    .loading {
      display: none;
      text-align: center;
      padding: 20px;
      color: #64748b;
    }
    .loading.show {
      display: block;
    }
    /* å¼¹çª—æ ·å¼ */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      overflow-y: auto;
    }
    .modal.show {
      display: block;
    }
    .modal-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 32px;
      border-radius: 16px;
      max-width: 900px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      position: relative;
    }
    .modal-header {
      font-size: 1.5rem;
      font-weight: 700;
      color: #205295;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid #e5e7eb;
    }
    .modal-close {
      position: absolute;
      top: 16px;
      right: 20px;
      font-size: 2rem;
      color: #64748b;
      cursor: pointer;
      transition: color 0.2s;
      background: none;
      border: none;
      padding: 0;
      line-height: 1;
    }
    .modal-close:hover {
      color: #ea580c;
    }
    .clickable {
      cursor: pointer;
      transition: all 0.2s;
    }
    .clickable:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(37, 99, 235, 0.3) !important;
    }
    .export-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
      transition: all 0.3s;
      z-index: 100;
      font-size: 0.95rem;
    }
    .export-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 18px rgba(37, 99, 235, 0.4);
    }
    /* æŠ˜å æ ·å¼ */
    .collapsible-row {
      cursor: pointer;
      background: #f1f5f9 !important;
      font-weight: 700;
    }
    .collapsible-row:hover {
      background: #e2e8f0 !important;
    }
    .collapse-icon {
      display: inline-block;
      transition: transform 0.3s;
      margin-right: 8px;
    }
    .collapse-icon.expanded {
      transform: rotate(90deg);
    }
    .collapsed {
      display: none;
    }
    .size-row {
      transition: background-color 0.2s ease;
    }
    .size-row:hover {
      background: #e8eaf6 !important;
    }
    /* å•†å“å›¾ç‰‡æ ·å¼ */
    .product-thumb {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #e5e7eb;
      background: #f9fafb;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s ease;
    }
    .product-thumb:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    .product-thumb-large {
      width: 44px;
      height: 44px;
    }
    .product-placeholder {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      border: 2px solid #e5e7eb;
    }
    .product-placeholder-large {
      width: 56px;
      height: 56px;
      font-size: 24px;
    }
    @media (max-width: 768px) {
      .header-title {
        font-size: 1.6rem;
      }
      .stats-cards {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      }
      .category-tabs {
        flex-direction: column;
        gap: 8px;
      }
      .top-list {
        grid-template-columns: 1fr;
      }
      .export-btn {
        top: 10px;
        right: 10px;
        padding: 10px 20px;
        font-size: 0.85rem;
      }
      .modal-content {
        margin: 10% 5%;
        padding: 20px;
      }
    }
  </style>
  <style>
    /* ç¾è§‚æ—¥æœŸæŒ‰é’®ä¸è¿›åº¦æ¡æ ·å¼ */
    .date-picker-wrap { display:flex; flex-wrap:wrap; gap:12px; }
    .date-btn {
      appearance:none; border:0; cursor:pointer;
      padding:12px 18px; border-radius:12px; font-weight:700;
      color:#fff; font-size:16px; letter-spacing:.3px;
      background: linear-gradient(135deg, #6366f1 0%, #3b82f6 100%);
      box-shadow: 0 6px 18px rgba(59,130,246,.25);
      transition: transform .15s ease, box-shadow .15s ease, filter .2s ease;
    }
    .date-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 24px rgba(59,130,246,.3); filter: brightness(1.02); }
    .date-btn:active { transform: translateY(0); box-shadow: 0 6px 18px rgba(59,130,246,.25); }
    .date-btn--primary { background: linear-gradient(135deg, #10b981 0%, #059669 100%); box-shadow: 0 6px 18px rgba(16,185,129,.25); }

    .progress { margin:8px 0 12px; height:10px; border-radius:999px; background:#e5e7eb; overflow:hidden; }
    .progress-bar { height:100%; width:0%; background: linear-gradient(90deg, #60a5fa, #3b82f6); transition: width .2s ease; }
    .progress-text { color:#64748b; font-size:14px; margin-bottom:6px; }
  </style>
</head>
<body>
  <!-- å¯¼å‡ºæŒ‰é’® -->
  <button class="export-btn" onclick="exportPageAsImage()">ğŸ“¸ å¯¼å‡ºå›¾ç‰‡</button>

  <div class="container">
    <div class="header">
      <div class="header-title">è·¨å¢ƒåº“å­˜åˆ†ææŠ¥è¡¨</div>
    </div>

    <!-- è¿‘ä¸‰æ—¥è‡ªåŠ¨å‘ç°ä¸æ—¥æœŸé€‰æ‹©ï¼ˆsource/ ç›¸å¯¹ç›®å½•ï¼‰ -->
    <div class="panel" id="autoPickerPanel">
      <div class="panel-title"><span>ğŸ“…</span>é€‰æ‹©æ—¥æœŸï¼ˆå‰ä¸‰æ—¥æŠ¥è¡¨ï¼‰</div>
      <div id="progressBox">
        <div class="progress-text" id="progressText">æ­£åœ¨æŸ¥æ‰¾è¿‘ä¸‰æ—¥æŠ¥è¡¨â€¦</div>
        <div class="progress"><div class="progress-bar" id="progressBar"></div></div>
      </div>
      <div id="date-picker" class="date-picker-wrap"></div>
      <div id="date-picker-hint" style="color:#64748b; font-size: 0.9rem; margin-top:8px;">
        æŸ¥æ‰¾è·¯å¾„ä¸‹å‰ä¸‰å¤©æ–‡ä»¶ä¸­ã€‚
      </div>
    </div>

    <div class="upload-box" id="uploadBox">
      <div>ğŸ“¦ æ‹–æ‹½ä¸Šä¼ Excelåº“å­˜è¡¨ï¼ˆ.xlsxï¼‰ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©</div>
      <input type="file" id="fileInput" accept=".xlsx,.xls" style="display:none;">
      <div class="file-info" id="fileInfo"></div>
    </div>

    <div class="loading" id="loading">æ­£åœ¨è§£ææ•°æ®ï¼Œè¯·ç¨å€™...</div>

    <!-- å›¾ç‰‡åŒ¹é…æ¦‚è§ˆæ¨¡å—å·²ç§»é™¤ -->

    <div id="reportBody" style="display:none;">
      <!-- åº“å­˜æ€»è§ˆ -->
      <div class="panel">
        <div class="panel-title"><span>ğŸ“Š</span>åº“å­˜æ€»è§ˆ</div>
        <div class="stats-cards" id="mainStats"></div>
      </div>

      <!-- æŒ‰å“ç±»åº“å­˜æ›²çº¿ -->
      <div class="panel">
        <div class="panel-title"><span>ğŸ“ˆ</span>æŒ‰å“ç±»åº“å­˜åˆ†å¸ƒ</div>
        <div class="category-tabs" id="categoryTabs"></div>
        <div class="category-tabs" id="sizeTabs" style="margin-top: 8px;"></div>
        <div id="catStockTotal" style="text-align: right; color:#1e3a8a; font-weight:700; margin: -6px 4px 8px 0;">&nbsp;</div>
        <div class="chart-box">
          <canvas id="catStockChart"></canvas>
        </div>
      </div>

      <!-- çƒ­é”€TOP5 -->
      <div class="panel">
        <div class="panel-title"><span>ğŸ”¥</span>å„å“ç±»TOP5çƒ­é”€SKUï¼ˆæŒ‰ç´¯è®¡é”€é‡ï¼‰</div>
        <div id="topSkuList"></div>
      </div>

      <!-- åŸå§‹æ˜ç»†ï¼ˆç§»åŠ¨è‡³ä½åº“å­˜é¢„è­¦ä¹‹å‰ï¼‰ -->
      <div class="panel">
        <div class="panel-title"><span>ğŸ“‹</span>åŸå§‹åº“å­˜æ˜ç»†è¡¨</div>
        <!-- åˆ†ç±»ç­›é€‰ä¸æ±‡æ€»/æ›²çº¿ï¼ˆç§»åŠ¨è‡³è¡¨æ ¼ä¸Šæ–¹ï¼‰ -->
        <div style="margin: 8px 0 16px 0;">
          <div id="category-buttons" class="category-tabs"></div>
          <div id="category-summary" class="stats-cards" style="margin-top: 8px; display: none;"></div>
          <div id="seamless-aggregates" class="stats-cards" style="margin: 8px 0; display: none;"></div>
          <div id="category-chart-box" style="display: none; gap: 12px; align-items: stretch; flex-wrap: wrap;">
            <div class="chart-box" id="cat-all-cum-box" style="height: 300px; flex: 1; min-width: 320px;">
              <canvas id="categorySkuChart"></canvas>
            </div>
            <div class="chart-box" id="cat-all-daily-box" style="height: 300px; flex: 1; min-width: 320px; display: none;">
              <canvas id="categorySkuChartDaily"></canvas>
            </div>
          </div>
        </div>
        <div class="table-wrapper" style="max-height: 640px; overflow-y: auto;">
          <table id="stockDetailTable"></table>
        </div>
      </div>

      <!-- ä½åº“å­˜é¢„è­¦ -->
      <div class="panel">
        <div class="panel-title"><span>â°</span>ä½åº“å­˜SKUé¢„è­¦ï¼ˆåº“å­˜ &lt; å‡ºè´§æ•°Ã—10%ï¼‰</div>
        <div class="table-wrapper">
          <table id="lowStockTable" class="dense">
            <thead>
              <tr>
                <th>å›¾ç‰‡</th>
                <th>å“ç±»</th>
                <th>SKU</th>
                <th>å°ºç </th>
                <th>å•†å“åç§°</th>
                <th>å½“å‰åº“å­˜</th>
                <th>å‡ºè´§æ•°</th>
                <th>é¢„è­¦é˜ˆå€¼</th>
                <th>æ—¥é”€æ•°é‡</th>
                <th>ç´¯è®¡é”€é‡</th>
                <th>çŠ¶æ€</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div id="lowStockPager" style="display:flex; gap:8px; align-items:center; justify-content:flex-end; margin-top:10px;">
          <button id="lowPrevBtn" class="category-tab" style="padding:6px 12px;">ä¸Šä¸€é¡µ</button>
          <span id="lowPageInfo" style="color:#64748b; font-size:0.9em;">ç¬¬ 1 / 1 é¡µ</span>
          <button id="lowNextBtn" class="category-tab" style="padding:6px 12px;">ä¸‹ä¸€é¡µ</button>
          <select id="lowPageSize" class="category-tab" style="padding:6px 12px;">
            <option value="50">æ¯é¡µ 50</option>
            <option value="100">æ¯é¡µ 100</option>
            <option value="200">æ¯é¡µ 200</option>
            <option value="0">å…¨éƒ¨</option>
          </select>
        </div>
      </div>
    </div>

    <div class="footer">Copyright Â© å—æç”µå•† - è¿›é”€å­˜æ™ºèƒ½æŠ¥è¡¨ v2.0</div>
  </div>

  <!-- å¼¹çª— -->
  <div id="modal" class="modal" onclick="closeModalOnBackdrop(event)">
    <div class="modal-content">
      <button class="modal-close" onclick="closeModal()">&times;</button>
      <div class="modal-header" id="modalTitle"></div>
      <div id="modalBody"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
    // ==================== å…¨å±€å˜é‡ ====================
    const CATEGORIES = ['ç‘œä¼½è£¤', 'è¿ä½“è¡£', 'æ— ç¼'];
    const SIZES = ['XS', 'S', 'M', 'L', 'XL', 'XXL'];
    let allData = [];
    let categoryMap = {};
    let chartInstance = null;
    let currentCategory = null;
    let currentSize = null;
    // é¢œè‰²ç åˆ°è‰²å€¼æ˜ å°„ï¼ˆç”¨äºæ— ç¼æ–‡èƒ¸è‰²å—ï¼‰
    function getColorHex(code) {
      const map = {
        'B': '#111827', // Black
        'W': '#ffffff', // White
        'P': '#ec4899', // Pink
        'AB': '#f5e6c8', // Beige/Apricot
        'BW': '#60a5fa', // Blue-ish
        'CC': '#a16207', // Cocoa/Amber-like
        'CB': '#1e3a8a', // Cobalt/Blue
        'ER': '#ef4444', // Red
        'GN': '#10b981', // Green
        'LB': '#93c5fd', // Light Blue
        'DG': '#374151', // Dark Gray
        'D': '#111827',  // Dark
        'MM': '#6b7280'  // Gray
      };
      return map[code] || '#e5e7eb';
    }

    function extractColorCodeFromSku(sku) {
      const m = String(sku || '').match(/-([^\-]+)$/);
      return m ? m[1] : '';
    }

    function buildColorSwatch(code, size) {
      const hex = getColorHex(code);
      const isLarge = size === 'large';
      const wh = isLarge ? 44 : 48;
      const br = '50%';
      const border = code === 'W' ? '1px solid #e5e7eb' : 'none';
      return `<div title="${code}" style="width:${wh}px;height:${wh}px;border-radius:${br};background:${hex};border:${border};display:inline-block;vertical-align:middle;"></div>`;
    }

    function shouldUseSwatchForRow(row) {
      if (!row) return false;
      if (row.category !== 'æ— ç¼') return false;
      const sub = detectSeamlessSubCategory(row.productName, row.sheetName);
      return sub === 'æ— ç¼æ–‡èƒ¸';
    }

    function renderRowImageOrSwatch(row, size) {
      if (shouldUseSwatchForRow(row)) {
        const code = extractColorCodeFromSku(row.sku);
        return buildColorSwatch(code, size);
      }
      if (row.imageUrl) {
        const cls = size === 'large' ? 'product-thumb product-thumb-large' : 'product-thumb';
        return `<img src="${row.imageUrl}" class="${cls}" alt="${row.sku}" />`;
      }
      return `<div class="product-placeholder${size==='large' ? ' product-placeholder-large' : ''}" title="ç¼ºå°‘å•†å“å›¾ç‰‡">ğŸ“¦</div>${size==='large' ? '' : '<span style="color:#dc2626; font-size:0.75em; margin-left:6px;">ç¼ºå›¾</span>'}`;
    }
    let imageMap = {}; // å­˜å‚¨å›¾ç‰‡é”®åˆ°base64
    let imageEntries = []; // [{ key, family, dataUrl }]
    let imageFileByKey = {}; // é”®å¯¹åº”çš„åŸå§‹å›¾ç‰‡æ–‡ä»¶åï¼ˆç”¨äºBåˆ—è¿‡æ»¤ï¼‰
    let anchorsBySheet = {}; // sheetName -> [{row,col,widthPx,heightPx,dataUrl}]
    let bImageByRow = {}; // sheetName -> { [row]: dataUrl }
    let bFilesBySheet = {}; // sheetName -> Set(imageFile)
    // ç¼ºå›¾ä¸åŒ¹é…ç»Ÿè®¡
    let missingImages = [];
    let matchStatsBySheet = {};
    let isWpsMode = false;

    // ==================== ä»Excelæå–æ‰€æœ‰å›¾ç‰‡æ–‡ä»¶ ====================
    async function extractImagesFromExcel(zip) {
      try {
        const imageFiles = {}; // { 'image1.png': 'data:image/png;base64,...' }

        // è·å–xl/media/ç›®å½•ä¸‹çš„æ‰€æœ‰å›¾ç‰‡
        const mediaFiles = [];
        zip.folder('xl/media').forEach((relativePath, file) => {
          if (!file.dir) {
            mediaFiles.push({ name: relativePath, file: file });
          }
        });

        console.log(`æ‰¾åˆ° ${mediaFiles.length} å¼ å›¾ç‰‡æ–‡ä»¶`);

        // å°†å›¾ç‰‡è½¬æ¢ä¸ºbase64
        for (const mediaFile of mediaFiles) {
          const blob = await mediaFile.file.async('blob');
          const base64 = await new Promise((resolve) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.readAsDataURL(blob);
          });

          // å­˜å‚¨å›¾ç‰‡ï¼Œæ–‡ä»¶åä½œä¸ºkey
          imageFiles[mediaFile.name] = base64;
        }

        console.log('å›¾ç‰‡æ–‡ä»¶æå–å®Œæˆ:', Object.keys(imageFiles).length);
        return imageFiles;
      } catch (error) {
        console.error('å›¾ç‰‡æ–‡ä»¶æå–å¤±è´¥:', error);
        return {};
      }
    }

    // ==================== é”®åè§„èŒƒåŒ–ä¸å»å™ª ====================
    function normalizeKey(key) {
      if (!key) return '';
      let s = String(key).trim();
      // å°† WF-02 CB â†’ WF-02-CB ç­‰ç©ºæ ¼è½¬æ¢ä¸ºè¿å­—ç¬¦
      s = s.replace(/\s+/g, '-');
      // å‹ç¼©è¿ç»­è¿å­—ç¬¦
      s = s.replace(/-+/g, '-');
      return s;
    }
    function isNoisyKey(key) {
      if (!key) return true;
      const s = String(key);
      if (s.startsWith('Snipaste_')) return true;
      if (!/^[A-Z]/i.test(s)) return true; // éå‰ç¼€å¼€å¤´çš„é”®å‰”é™¤
      return false;
    }

    // ==================== è§£æå›¾ç‰‡ä¸SKUçš„æ˜ å°„å…³ç³»ï¼ˆåŸºäºcellimages.xmlï¼‰ ====================
    async function extractImageMappingFromDrawings(zip, workbook, imageFiles) {
      try {
        console.log('\n========== å¼€å§‹è§£æå›¾ç‰‡ä¸SKUçš„æ˜ å°„å…³ç³» ==========');

        // 1. è§£æ cellimages.xml.relsï¼Œå»ºç«‹ rId åˆ°å›¾ç‰‡æ–‡ä»¶çš„æ˜ å°„
        const relsFile = zip.file('xl/_rels/cellimages.xml.rels');
        if (!relsFile) {
          console.warn('âš ï¸ æœªæ‰¾åˆ° cellimages.xml.rels æ–‡ä»¶ï¼Œä½¿ç”¨æ–‡ä»¶ååŒ¹é…');
          return imageFiles;
        }

        const relsXml = await relsFile.async('string');
        const relsParser = new DOMParser();
        const relsDoc = relsParser.parseFromString(relsXml, 'text/xml');

        const ridToImage = {};
        const relationships = relsDoc.querySelectorAll('Relationship');
        relationships.forEach(rel => {
          const rid = rel.getAttribute('Id');
          const target = rel.getAttribute('Target');
          if (target && target.startsWith('media/')) {
            const imageFilename = target.replace('media/', '');
            ridToImage[rid] = imageFilename;
          }
        });

        console.log(`âœ“ è§£æ rels æ–‡ä»¶å®Œæˆï¼Œæ‰¾åˆ° ${Object.keys(ridToImage).length} ä¸ªå›¾ç‰‡æ˜ å°„`);

        // 2. è§£æ cellimages.xmlï¼Œå»ºç«‹ SKU æè¿°åˆ° rId çš„æ˜ å°„
        const cellImagesFile = zip.file('xl/cellimages.xml');
        if (!cellImagesFile) {
          console.warn('âš ï¸ æœªæ‰¾åˆ° cellimages.xml æ–‡ä»¶ï¼Œä½¿ç”¨æ–‡ä»¶ååŒ¹é…');
          return imageFiles;
        }

        const cellImagesXml = await cellImagesFile.async('string');
        const cellImagesParser = new DOMParser();
        const cellImagesDoc = cellImagesParser.parseFromString(cellImagesXml, 'text/xml');

        const skuToImage = {};
        const cellImages = cellImagesDoc.querySelectorAll('cellImage');

        cellImages.forEach(cellImage => {
          // è·å–æè¿°ï¼ˆSKUåç§°ï¼‰
          const cNvPr = cellImage.querySelector('cNvPr');
          if (cNvPr) {
            const descr = cNvPr.getAttribute('descr');

            // è·å–å…³ç³»ID
            const blip = cellImage.querySelector('blip');
            if (blip && descr) {
              const rid = blip.getAttribute('r:embed');

              if (rid && ridToImage[rid]) {
                // æ¸…ç†æè¿°ä¿¡æ¯ï¼ˆç§»é™¤ " 01" åç¼€ï¼Œå› ä¸ºè¿™æ˜¯å°å›¾æ ‡è®°ï¼‰
                const cleanDescrRaw = descr.replace(/ 01$/, '').trim();
                const cleanDescr = normalizeKey(cleanDescrRaw);
                if (isNoisyKey(cleanDescr)) return;

                // å¦‚æœè¯¥SKUè¿˜æ²¡æœ‰æ˜ å°„ï¼Œæˆ–è€…å½“å‰æè¿°æ²¡æœ‰ " 01" åç¼€ï¼ˆä¼˜å…ˆå¤§å›¾ï¼‰
                if (!skuToImage[cleanDescr] || !descr.includes(' 01')) {
                  const imageFile = ridToImage[rid];
                  const dataUrl = imageFiles[imageFile];
                  skuToImage[cleanDescr] = dataUrl;
                  // è®°å½•æ¡ç›®åˆ° imageEntriesï¼ˆç”¨äºå®¶æ—è¿‡æ»¤ä¸é¢œè‰²å›é€€ï¼‰
                  imageEntries.push({ key: cleanDescr, family: getKeyFamily(cleanDescr), dataUrl });
                  imageFileByKey[cleanDescr] = imageFile;
                  console.log(`  ${cleanDescr.padEnd(30)} â†’ ${imageFile}`);
                }
              }
            }
          }
        });

        console.log(`âœ“ è§£æ cellimages.xml å®Œæˆï¼Œå»ºç«‹ ${Object.keys(skuToImage).length} ä¸ª SKU åˆ°å›¾ç‰‡çš„æ˜ å°„`);
        console.log('================================\n');

        return skuToImage;
      } catch (error) {
        console.error('âŒ è§£æå›¾ç‰‡æ˜ å°„å¤±è´¥:', error);
        console.log('ğŸ’¡ å›é€€åˆ°æ–‡ä»¶ååŒ¹é…æ¨¡å¼\n');
        return imageFiles;
      }
    }

    // ==================== æ„å»ºç»˜å›¾é”šç‚¹ï¼ˆå·¥ä½œè¡¨Båˆ—ä¸»å›¾ï¼‰ ====================
    async function buildSheetDrawingMap(zip, workbook, imageFiles) {
      anchorsBySheet = {};
      try {
        let foundSheetRels = false;
        for (let s = 0; s < workbook.SheetNames.length; s++) {
          const sheetName = workbook.SheetNames[s];
          const sheetPath = `xl/worksheets/sheet${s + 1}.xml`;
          const relsPath = `xl/worksheets/_rels/sheet${s + 1}.xml.rels`;
          const relsFile = zip.file(relsPath);
          if (!relsFile) {
            console.log(`[drawings] è¡¨ ${sheetName}ï¼šæœªæ‰¾åˆ° rels (${relsPath})ï¼Œè·³è¿‡é”šç‚¹è§£æ`);
            continue;
          }
          foundSheetRels = true;
          const relsXml = await relsFile.async('string');
          const relsDoc = new DOMParser().parseFromString(relsXml, 'text/xml');
          let drawingTarget = null;
          relsDoc.querySelectorAll('Relationship').forEach(rel => {
            const type = rel.getAttribute('Type') || '';
            if (type.includes('/drawing')) {
              drawingTarget = rel.getAttribute('Target');
            }
          });
          if (!drawingTarget) {
            console.log(`[drawings] è¡¨ ${sheetName}ï¼šæœªç»‘å®šdrawingå…³ç³»ï¼Œè·³è¿‡`);
            continue;
          }
          const drawingPath = `xl/worksheets/${drawingTarget}`.replace('worksheets/drawings/', 'drawings/');
          const drawingRelsPath = drawingPath.replace('drawings/', 'drawings/_rels/') + '.rels';
          const drawingXmlFile = zip.file(drawingPath);
          const drawingRelsFile = zip.file(drawingRelsPath);
          if (!drawingXmlFile || !drawingRelsFile) {
            console.log(`[drawings] è¡¨ ${sheetName}ï¼šdrawingæˆ–å…¶relsç¼ºå¤±ï¼Œè·³è¿‡ (${drawingPath})`);
            continue;
          }
          const drawingXml = await drawingXmlFile.async('string');
          const drawingDoc = new DOMParser().parseFromString(drawingXml, 'text/xml');
          const dRelsXml = await drawingRelsFile.async('string');
          const dRelsDoc = new DOMParser().parseFromString(dRelsXml, 'text/xml');
          const ridToImg = {};
          dRelsDoc.querySelectorAll('Relationship').forEach(rel => {
            const id = rel.getAttribute('Id');
            const target = rel.getAttribute('Target') || '';
            // å…¼å®¹å¤šç§ç›¸å¯¹è·¯å¾„ï¼Œç»Ÿä¸€å–æ–‡ä»¶å
            const file = (target.split('/').pop() || '').trim();
            ridToImg[id] = file;
          });
          const anchors = [];
          const picAnchors = drawingDoc.querySelectorAll('twoCellAnchor, oneCellAnchor');
          picAnchors.forEach(anc => {
            const from = anc.querySelector('from');
            const col = from ? parseInt(from.querySelector('col')?.textContent || '0', 10) : 0;
            const row = from ? parseInt(from.querySelector('row')?.textContent || '0', 10) : 0;
            const blip = anc.querySelector('pic blip');
            const rid = blip ? blip.getAttribute('r:embed') : null;
            const ext = anc.querySelector('ext');
            const cx = ext ? parseInt(ext.getAttribute('cx') || '0', 10) : 0;
            const cy = ext ? parseInt(ext.getAttribute('cy') || '0', 10) : 0;
            const widthPx = Math.round(cx / 9525);
            const heightPx = Math.round(cy / 9525);
            if (!rid || !ridToImg[rid]) return;
            const file = ridToImg[rid];
            const dataUrl = imageFiles[file];
            if (!dataUrl) return;
            anchors.push({ row, col, widthPx, heightPx, dataUrl, file });
          });
          anchorsBySheet[sheetName] = anchors;

          // æ‰“å°æ¯è¡¨é”šç‚¹ç»Ÿè®¡
          const bCount = (anchors || []).filter(a => a.col === 1).length;
          console.log(`[drawings] è¡¨ ${sheetName}ï¼šæ€»é”šç‚¹=${anchors.length}, Båˆ—é”šç‚¹=${bCount}`);
        }
        // è‹¥æ•´ä¸ªå·¥ä½œç°¿å‡æœªå‘ç°sheet relsï¼Œåˆ™æ ‡è®°WPSæ¨¡å¼ï¼ˆæœ€ç»ˆä»¥å¤–å±‚æ£€æµ‹ä¸ºå‡†ï¼‰
        if (!foundSheetRels) {
          console.log('â„¹ï¸ æ‰€æœ‰å·¥ä½œè¡¨å‡ç¼ºå°‘ sheet relsï¼Œç–‘ä¼¼WPSæ–‡ä»¶');
        }
      } catch (e) {
        console.warn('è§£æç»˜å›¾é”šç‚¹å¤±è´¥ï¼š', e);
      }
    }

    function buildBImageMap() {
      bImageByRow = {};
      bFilesBySheet = {};
      Object.keys(anchorsBySheet).forEach(sheetName => {
        const anchors = anchorsBySheet[sheetName] || [];
        const bAnchors = anchors.filter(a => a.col === 1); // ä»…Båˆ—
        const byRow = {};
        const fileSet = new Set();
        bAnchors.forEach(a => {
          const key = a.row;
          const area = (a.widthPx || 0) * (a.heightPx || 0);
          if (!byRow[key] || area > byRow[key].area) {
            byRow[key] = { area, dataUrl: a.dataUrl, file: a.file };
          }
          if (a.file) fileSet.add(a.file);
        });
        bImageByRow[sheetName] = {};
        Object.keys(byRow).forEach(r => {
          bImageByRow[sheetName][parseInt(r, 10)] = byRow[r].dataUrl;
        });
        bFilesBySheet[sheetName] = fileSet;
        console.log(`[Båˆ—æ˜ å°„] è¡¨ ${sheetName}ï¼šBåˆ—è¡Œæ˜ å°„=${Object.keys(byRow).length}, æ–‡ä»¶é›†å¤§å°=${fileSet.size}`);
      });
    }

    // ==================== å“ç±»è¯†åˆ«å‡½æ•° ====================
    function detectCategory(productName) {
      if (!productName) return 'å…¶ä»–';
      // å…ˆæ£€æŸ¥"æ— ç¼"ç›¸å…³å•†å“ï¼ˆé¿å…è¢«å…¶ä»–å“ç±»è¯¯åŒ¹é…ï¼‰
      if (productName.includes('æ— ç¼')) return 'æ— ç¼';
      if (productName.includes('ç‘œä¼½è£¤')) return 'ç‘œä¼½è£¤';
      if (productName.includes('è¿ä½“è¡£')) return 'è¿ä½“è¡£';
      return 'å…¶ä»–';
    }

    // ==================== æ— ç¼å­å“ç±»è¯†åˆ«ï¼ˆæ–‡èƒ¸/ç‘œä¼½è£¤ï¼‰ ====================
    function detectSeamlessSubCategory(productName, sheetName) {
      const name = String(productName || '');
      const sheet = String(sheetName || '');
      // ä¼˜å…ˆç”¨å·¥ä½œè¡¨å‰ç¼€å¼ºåˆ¤å®šï¼Œé¿å…è¯¯åˆ¤
      if (/^NJ-\s*BR/i.test(sheet) || sheet.includes('NJ-BR')) return 'æ— ç¼æ–‡èƒ¸';
      if (/^NJ-\s*LG/i.test(sheet) || sheet.includes('NJ-LG')) return 'æ— ç¼ç‘œä¼½è£¤';
      if (name.includes('æ–‡èƒ¸')) return 'æ— ç¼æ–‡èƒ¸';
      if (name.includes('ç‘œä¼½è£¤')) return 'æ— ç¼ç‘œä¼½è£¤';
      return 'æ— ç¼';
    }

    // ==================== å®¶æ—è¯†åˆ«ä¸ç™½åå•ï¼ˆæ›´ä¸¥æ ¼ï¼‰ ====================
    function getKeyFamily(key) {
      const s = String(key || '');
      if (s.startsWith('WF01-')) return 'WF01';
      if (s.startsWith('WF-02')) return 'WF-02';
      const seg = s.split(/[-\s]/)[0] || '';
      return seg.toUpperCase();
    }
    function getAllowedFamilies(category, seamlessSubCat) {
      if (seamlessSubCat === 'æ— ç¼æ–‡èƒ¸') return ['WF01', 'WF', 'WF-02'];
      if (seamlessSubCat === 'æ— ç¼ç‘œä¼½è£¤') return ['RG', 'WP', 'WF01', 'WF', 'WF-02'];
      if (category === 'è¿ä½“è¡£') return ['LLSS', 'NSSS', 'SLSS', 'SS', 'SL'];
      if (category === 'ç‘œä¼½è£¤') return ['RG', 'WP'];
      if (category === 'æ— ç¼') return ['WF01', 'WF', 'WF-02'];
      return [];
    }
    function isKeyAllowedByWhitelist(key, category, seamlessSubCat) {
      const fam = getKeyFamily(key);
      const allowed = getAllowedFamilies(category, seamlessSubCat);
      return allowed.length === 0 ? true : allowed.includes(fam);
    }
    function shouldEnforceBFilter(category, seamlessSubCat) {
      // ä»…æ— ç¼æ–‡èƒ¸å¯ç”¨Båˆ—è¿‡æ»¤ï¼›æ— ç¼ç‘œä¼½è£¤ç¦ç”¨
      return seamlessSubCat === 'æ— ç¼æ–‡èƒ¸';
    }

    // ==================== æ–‡ä»¶ä¸Šä¼ å¤„ç† ====================
    document.getElementById('fileInput').onchange = function(e) {
      if (e.target.files[0]) handleFile(e.target.files[0]);
    };

    document.getElementById('uploadBox').onclick = function() {
      document.getElementById('fileInput').click();
    };

    document.getElementById('uploadBox').ondragover = function(e) {
      e.preventDefault();
      this.classList.add('dragover');
    };

    document.getElementById('uploadBox').ondragleave = function(e) {
      this.classList.remove('dragover');
    };

    document.getElementById('uploadBox').ondrop = function(e) {
      e.preventDefault();
      this.classList.remove('dragover');
      if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
    };

    // ==================== Excelæ–‡ä»¶è§£æ ====================
    async function handleFile(file) {
      if (!file.name.match(/\.(xlsx|xls)$/)) {
        alert('è¯·ä¸Šä¼ Excelè¡¨ (.xlsx æˆ– .xls)');
        return;
      }

      document.getElementById('fileInfo').textContent = `æ–‡ä»¶ï¼š${file.name}`;
      document.getElementById('loading').classList.add('show');

      try {
        // è¯»å–æ–‡ä»¶ä¸ºArrayBuffer
        const arrayBuffer = await file.arrayBuffer();

        // åˆ›å»ºJSZipå®ä¾‹
        const zip = await JSZip.loadAsync(arrayBuffer);

        // 1. æå–æ‰€æœ‰å›¾ç‰‡æ–‡ä»¶ï¼ˆæ–‡ä»¶å -> base64æ˜ å°„ï¼‰
        const imageFiles = await extractImagesFromExcel(zip);
        console.log(`æå–åˆ° ${Object.keys(imageFiles).length} ä¸ªå›¾ç‰‡æ–‡ä»¶`);

        // 2. è§£æExcelå·¥ä½œç°¿
        const workbook = XLSX.read(arrayBuffer, { type: 'array', cellFormula: false });

        // 3. è§£æDrawing XMLï¼Œå»ºç«‹Båˆ—å›¾ç‰‡æ˜ å°„ï¼ˆsheet -> è¡Œå· -> å›¾ç‰‡ï¼‰
        await buildSheetDrawingMap(zip, workbook, imageFiles);
        buildBImageMap();
        // æ£€æµ‹WPSæ¨¡å¼ï¼šæ‰€æœ‰è¡¨Båˆ—æ–‡ä»¶é›†å‡ä¸ºç©º
        try {
          const sets = Object.values(bFilesBySheet || {});
          isWpsMode = sets.length > 0 && sets.every(s => !s || s.size === 0);
          if (isWpsMode) console.log('âš™ï¸ WPS å…¼å®¹æ¨¡å¼å·²å¯ç”¨ï¼šç¦ç”¨Båˆ—è¿‡æ»¤ï¼Œä¾èµ–cellimagesåŒ¹é…');
        } catch (e) { isWpsMode = false; }

        // 3.1 è§£æ cellimages.xmlï¼Œå»ºç«‹ SKU æè¿°æ˜ å°„ï¼ˆç”¨äºå›é€€ï¼‰
        imageMap = await extractImageMappingFromDrawings(zip, workbook, imageFiles);
        console.log('å›¾ç‰‡æ˜ å°„æ„å»ºå®Œæˆ:', imageMap);

        allData = [];

        // éå†æ‰€æœ‰å·¥ä½œè¡¨
        workbook.SheetNames.forEach(sheetName => {
          const worksheet = workbook.Sheets[sheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet, {
            header: 1,
            defval: '',
            raw: false
          });

          console.log('========================================');
          console.log('å·¥ä½œè¡¨åç§°:', sheetName);
          console.log('æ€»è¡Œæ•°:', jsonData.length);
          console.log('========================================');
          console.log('å¼€å§‹è§£ææ•°æ®...');
          console.log('========================================\n');

          // è§£ææ•°æ® - åŠ¨æ€æŸ¥æ‰¾æ•°æ®è¡Œ
          // å°è¯•è¯†åˆ«é€€æ¬¾åˆ—ç´¢å¼•ï¼ˆä»å‰å‡ è¡Œè¡¨å¤´ä¸­æå–åŒ…å«â€œé€€â€çš„åˆ—ï¼‰
          const refundHeaderCandidates = ['é€€æ¬¾', 'é€€æ¬¾é‡', 'é€€è´§', 'é€€è´§é‡', 'é€€æ¬¾ï¼ˆæ¬¾ï¼‰é‡', 'é€€æ¬¾(æ¬¾)é‡', 'é€€'];
          let refundColIndex = -1;
          for (let hr = 0; hr < Math.min(10, jsonData.length); hr++) {
            const hdr = jsonData[hr] || [];
            for (let c = 0; c < hdr.length; c++) {
              const name = String(hdr[c] || '').trim();
              if (!name) continue;
              if (refundHeaderCandidates.some(k => name.includes(k))) {
                refundColIndex = c;
                break;
              }
            }
            if (refundColIndex !== -1) break;
          }
          if (refundColIndex === -1) {
            console.log(`â„¹ï¸ æœªè¯†åˆ«åˆ°é€€æ¬¾åˆ—ï¼Œè¡¨ ${sheetName} å°†æŒ‰0å¤„ç†`);
          } else {
            console.log(`âœ“ è¯†åˆ«é€€æ¬¾åˆ—ï¼šè¡¨ ${sheetName} åˆ—ç´¢å¼•=${refundColIndex}`);
          }

          // è¯†åˆ«ç§»é™¤é‡åˆ—ï¼ˆç”¨äºæ¨å¯¼é€€æ¬¾é‡ï¼‰
          const removalHeaderCandidates = ['ç§»é™¤', 'ç§»é™¤é‡', 'ç§»å‡º', 'ç§»åº“', 'åº“å­˜ç§»é™¤'];
          let removalColIndex = -1;
          for (let hr = 0; hr < Math.min(10, jsonData.length); hr++) {
            const hdr = jsonData[hr] || [];
            for (let c = 0; c < hdr.length; c++) {
              const name = String(hdr[c] || '').trim();
              if (!name) continue;
              if (removalHeaderCandidates.some(k => name.includes(k))) {
                removalColIndex = c;
                break;
              }
            }
            if (removalColIndex !== -1) break;
          }
          if (removalColIndex === -1) {
            console.log(`â„¹ï¸ æœªè¯†åˆ«åˆ°ç§»é™¤åˆ—ï¼Œè¡¨ ${sheetName} å°†æŒ‰0å¤„ç†`);
          } else {
            console.log(`âœ“ è¯†åˆ«ç§»é™¤åˆ—ï¼šè¡¨ ${sheetName} åˆ—ç´¢å¼•=${removalColIndex}`);
          }
          // è·³è¿‡è¡¨å¤´ï¼ŒæŸ¥æ‰¾åŒ…å«åºå·çš„æ•°æ®è¡Œ
          let totalSkuCount = 0;
          let matchedSkuCount = 0;
          for (let i = 4; i < jsonData.length; i++) {
            const row = jsonData[i];

            // è·³è¿‡ç©ºè¡Œ
            if (!row || row.length === 0) {
              continue;
            }

            // è·³è¿‡è¡¨å¤´è¡Œï¼ˆç¬¬ä¸€åˆ—æ˜¯"åºå·"ï¼‰
            if (row[0] === 'åºå·' || row[10] === 'å‡ºè´§æ•°' || row[10] === 'é‡‡è´­') {
              continue;
            }

            // è·³è¿‡å°è®¡è¡Œ
            if (row[9] === 'å°è®¡') {
              continue;
            }

            // æ£€æŸ¥æ˜¯å¦æ˜¯ä¸»æ•°æ®è¡Œï¼ˆåŒ…å«SKUï¼‰
            const sku = row[2]; // åˆ—C (ç´¢å¼•2)
            const productName = row[3]; // åˆ—D (ç´¢å¼•3)

            // å¦‚æœæ²¡æœ‰SKUæˆ–å•†å“åç§°ï¼Œè¯´æ˜æ˜¯å°ºç è¡Œï¼ˆéä¸»æ•°æ®è¡Œï¼‰
            if (!sku || !productName) {
              continue;
            }

            const category = detectCategory(productName);
            const seamlessSubCat = category === 'æ— ç¼' ? detectSeamlessSubCategory(productName, sheetName) : null;
            console.log(`\næ­£åœ¨è§£æ SKU: ${sku}, å•†å“: ${productName}, å“ç±»: ${category}`);

            // æ¯æ¡SKUå¼€å§‹å…ˆå®šä¹‰å›¾ç‰‡å˜é‡
            let imageUrl = null;
            let matchedSku = null;
            totalSkuCount++;

            // ä¼˜å…ˆï¼šBåˆ—ä¸»å›¾ï¼ˆåŸºäºé”šç‚¹ï¼‰
            const bMap = bImageByRow[sheetName] || {};
            const bSet = bFilesBySheet[sheetName];
            const enforceB = !isWpsMode && shouldEnforceBFilter(category, seamlessSubCat) && bSet && bSet.size > 0;
            if (!bSet || bSet.size === 0) {
              console.log(`  â„¹ï¸ å½“å‰è¡¨Båˆ—æ–‡ä»¶é›†ä¸ºç©ºæˆ–æœªè§£æï¼Œæ”¾å®½è¿‡æ»¤: ${sheetName}`);
            } else {
              console.log(`  â„¹ï¸ å½“å‰è¡¨Båˆ—æ–‡ä»¶é›†å¤§å°: ${bSet.size}`);
            }
            const neighborRows = [i, i - 1, i + 1];
            for (const r of neighborRows) {
              if (r >= 0 && bMap[r]) {
                imageUrl = bMap[r];
                matchedSku = 'B-COLUMN-ANCHOR';
                break;
              }
            }

            // 1. ç›´æ¥ç²¾ç¡®åŒ¹é…ï¼ˆå—ç™½åå•çº¦æŸï¼‰
            if (!imageUrl && imageMap[sku] && isKeyAllowedByWhitelist(sku, category, seamlessSubCat)) {
              const candidateFile = imageFileByKey[sku];
              if (!enforceB || (candidateFile && bSet && bSet.has(candidateFile))) {
                imageUrl = imageMap[sku];
                matchedSku = !enforceB ? sku : `${sku}-B-FILTERED`;
              } else {
                console.log(`  â›” è·³è¿‡ç²¾ç¡®åŒ¹é…(ä¸åœ¨Båˆ—): ${sku} â†’ æ–‡ä»¶=${candidateFile}`);
              }
            }

            // 2. æå–å…³é”®éƒ¨åˆ†åŒ¹é…ï¼ˆå¤„ç† NJ-BS-LL-SS25-AB â†’ LLSS-AB çš„è½¬æ¢ï¼‰
            if (!imageUrl) {
              // æå–è§„å¾‹ï¼šNJ-{å“ç±»}-{ç³»åˆ—}-{å­£èŠ‚}-{é¢œè‰²} â†’ {ç³»åˆ—}{å­£èŠ‚ç¼©å†™}-{é¢œè‰²}
              const skuParts = sku.split('-');

              if (skuParts.length >= 5) {
                // ä¾‹å¦‚ï¼šNJ-BS-LL-SS25-AB
                const series = skuParts[2]; // LL, NS, SL, SS, RG, WP
                const season = skuParts[3]; // SS25, AW25
                const color = skuParts.slice(4).join('-'); // AB (æˆ– WF-02 è¿™æ ·çš„)

                // ç”Ÿæˆå¯èƒ½çš„ç¼©å†™å½¢å¼
                const abbreviations = [
                  `${series}${season.substring(0, 2)}-${color}`, // LLSS-AB / WF01-AB â€¦
                  `${series}-${color}`,
                  `${season.substring(0, 2)}-${color}`
                ].filter(key => isKeyAllowedByWhitelist(key, category, seamlessSubCat));

                // å°è¯•æ‰€æœ‰å¯èƒ½çš„ç¼©å†™
                for (const abbr of abbreviations) {
                  if (imageMap[abbr]) {
                    const candidateFile = imageFileByKey[abbr];
                    if (!enforceB || (candidateFile && bSet && bSet.has(candidateFile))) {
                      imageUrl = imageMap[abbr];
                      matchedSku = !enforceB ? abbr : `${abbr}-B-FILTERED`;
                      console.log(`  âœ… æ™ºèƒ½åŒ¹é…: ${sku} â†’ ${abbr}`);
                      break;
                    } else {
                      console.log(`  â›” è·³è¿‡æ™ºèƒ½åŒ¹é…(ä¸åœ¨Båˆ—): ${abbr} â†’ æ–‡ä»¶=${candidateFile}`);
                    }
                  }
                }
              }
            }

            // 3. ç‰¹æ®Šè§„åˆ™åŒ¹é…ï¼ˆå¤„ç†ç‰¹æ®Šå‘½åè§„åˆ™ï¼‰
            if (!imageUrl) {
              // å°è¯•æŸ¥æ‰¾åŒ…å«é¢œè‰²ä»£ç çš„åŒ¹é…
              const colorMatch = sku.match(/-([A-Z]{1,3})$/); // æå–æœ€åçš„é¢œè‰²ä»£ç 
              if (colorMatch) {
                const color = colorMatch[1];
                // æ— ç¼-ç‘œä¼½è£¤æ”¾å®½ä¸ºè·¨å®¶æ—é¢œè‰²å›é€€ï¼›å…¶ä½™ä»æŒ‰ç™½åå•
                const allowedFamilies = getAllowedFamilies(category, seamlessSubCat);
                for (const entry of imageEntries) {
                  if (seamlessSubCat !== 'æ— ç¼ç‘œä¼½è£¤' && !allowedFamilies.includes(entry.family)) continue;
                  const k = entry.key;
                  if (k.endsWith(`-${color}`) || k.endsWith(` ${color}`)) {
                    const candidateFile = imageFileByKey[k];
                    if (!enforceB || (candidateFile && bSet && bSet.has(candidateFile))) {
                      imageUrl = entry.dataUrl;
                      matchedSku = !enforceB ? k : `${k}-B-FILTERED`;
                      console.log(`  âœ… é¢œè‰²åŒ¹é…: ${sku} â†’ ${k} [${entry.family}]`);
                      break;
                    } else {
                      // ä¸åœ¨Båˆ—é›†åˆ
                    }
                  }
                }
              }
            }

            if (imageUrl) {
              console.log(`  âœ… æ‰¾åˆ°åŒ¹é…å›¾ç‰‡: ${matchedSku} (${seamlessSubCat || category})`);
              matchedSkuCount++;
            } else {
              console.log(`  âš ï¸ æœªæ‰¾åˆ°åŒ¹é…å›¾ç‰‡ï¼ŒSKU: ${sku}`);
              console.log(`     å¯ç”¨çš„SKUåˆ—è¡¨:`, Object.keys(imageMap).slice(0, 5).join(', '), '...');
              // è®°å½•ç¼ºå›¾
              const colorTail = String(sku || '').match(/-([^\-]+)$/);
              const color = colorTail ? colorTail[1] : '';
              missingImages.push({
                sheet: sheetName,
                category,
                productName,
                sku,
                color,
                expectedFamilies: getAllowedFamilies(category, seamlessSubCat)
              });
            }

            // è§£æ6ä¸ªå°ºç çš„æ•°æ®ï¼ˆä»å½“å‰è¡Œå¼€å§‹çš„6è¡Œï¼‰
            const sizes = ['XS', 'S', 'M', 'L', 'XL', 'XXL'];

            for (let sizeIndex = 0; sizeIndex < 6; sizeIndex++) {
              const dataRow = jsonData[i + sizeIndex];

              if (!dataRow || dataRow.length === 0) {
                console.warn(`  è·³è¿‡ç©ºè¡Œ: è¡Œç´¢å¼• ${i + sizeIndex}`);
                continue;
              }

              const size = sizes[sizeIndex];
              const shipQty = parseFloat(dataRow[10]) || 0; // åˆ—K (ç´¢å¼•10) - å‡ºè´§æ•°
              const stock = parseFloat(dataRow[15]) || 0; // åˆ—P (ç´¢å¼•15) - åº“å­˜æ•°é‡
              const dailySales = parseFloat(dataRow[13]) || 0; // åˆ—N (ç´¢å¼•13) - æ—¥é”€æ•°é‡
              const totalSales = parseFloat(dataRow[14]) || 0; // åˆ—O (ç´¢å¼•14) - ç´¯è®¡é”€é‡
              const rawRefund = refundColIndex >= 0 ? (parseFloat(dataRow[refundColIndex]) || 0) : 0;
              const removalQty = removalColIndex >= 0 ? (parseFloat(dataRow[removalColIndex]) || 0) : 0;
              // æ¨å¯¼é€€æ¬¾é‡ï¼šåº“å­˜æ•°é‡ = å‡ºè´§æ•° - ç´¯è®¡é”€é‡ + é€€æ¬¾é‡ + ç§»é™¤é‡
              // => é€€æ¬¾é‡ = åº“å­˜æ•°é‡ - å‡ºè´§æ•° + ç´¯è®¡é”€é‡ - ç§»é™¤é‡
              const derivedRefund = (stock - shipQty + totalSales - removalQty);
              const refundQty = Number.isFinite(derivedRefund) ? derivedRefund : rawRefund;

              allData.push({
                sheetName: sheetName,
                category: category,
                sku: sku,
                size: size,
                productName: productName,
                imageUrl: imageUrl, // æ·»åŠ å›¾ç‰‡URL
                shipQty: shipQty,
                stock: stock,
                dailySales: dailySales,
                totalSales: totalSales,
                refundQty: refundQty,
                removalQty: removalQty
              });

              console.log(`  âœ“ ${size}: å‡ºè´§æ•°=${shipQty}, ç´¯è®¡é”€é‡=${totalSales}, ç§»é™¤=${removalQty}, åº“å­˜=${stock} â†’ é€€æ¬¾=${refundQty}`);
            }

            // è·³è¿‡è¿™ä¸ªSKUçš„å‰©ä½™è¡Œï¼ˆ6ä¸ªå°ºç è¡Œ+å°è®¡è¡Œ+ç©ºè¡Œ = 8è¡Œï¼Œä½†å·²å¤„ç†äº†ä¸»æ•°æ®è¡Œï¼Œæ‰€ä»¥è·³è¿‡7è¡Œï¼‰
            i += 7;
          }
          matchStatsBySheet[sheetName] = { total: totalSkuCount, matched: matchedSkuCount, missing: Math.max(0, totalSkuCount - matchedSkuCount), bFiles: (bFilesBySheet[sheetName] ? bFilesBySheet[sheetName].size : 0) };
        });

        console.log(`\nè§£æå®Œæˆï¼å…±è§£æäº† ${allData.length} æ¡æ•°æ®è®°å½•`);
        // æ‰“å°åŒ¹é…ç‡æ±‡æ€»
        Object.keys(matchStatsBySheet).forEach(k => {
          const st = matchStatsBySheet[k];
          const rate = st.total ? ((st.matched / st.total) * 100).toFixed(1) : '0.0';
          console.log(`[åŒ¹é…ç‡] è¡¨ ${k}ï¼š${st.matched}/${st.total} (${rate}%)ï¼Œç¼ºå›¾=${st.missing}ï¼ŒBåˆ—æ–‡ä»¶é›†=${st.bFiles}`);
        });

        // æ•°æ®è§£æå®Œæˆåï¼Œæ„å»ºåˆ†ææŠ¥è¡¨
        if (allData.length > 0) {
          buildAnalysis();
        } else {
          alert('æœªèƒ½è§£æåˆ°æœ‰æ•ˆæ•°æ®ï¼Œè¯·æ£€æŸ¥Excelæ–‡ä»¶æ ¼å¼');
        }

        document.getElementById('loading').classList.remove('show');

      } catch (error) {
        document.getElementById('loading').classList.remove('show');
        alert('è§£ææ–‡ä»¶æ—¶å‡ºé”™ï¼š' + error.message);
        console.error(error);
      }
    }

    // ==================== æ•°æ®åˆ†æä¸»æµç¨‹ ====================
    function buildAnalysis() {
      buildCategoryMap();
      renderStats();
      renderCategoryTabs();
      renderLowStock();
      renderTopSku();
      renderStockDetail();
      renderCategoryButtons();
      // åˆå¹¶æ— ç¼å­ç±»æŒ‰é’®åˆ°ä¸»åˆ†ç±»æŒ‰é’®è¡Œ

      // æ— ç¼å­ç±»ç­›é€‰ä¸æ±‡æ€»
      bindSeamlessButtons();
      renderSeamlessAggregatesForCurrent();

      document.getElementById('reportBody').style.display = 'block';

      // é»˜è®¤æ˜¾ç¤ºï¼šåŸå§‹æ˜ç»†â€œå…¨éƒ¨â€æ±‡æ€»ä¸å¯¹æ¯”æ›²çº¿
      setTimeout(() => {
        applyCategoryFilter('å…¨éƒ¨');
      }, 50);

      // ä¿æŒåŸæœ‰ä¸Šæ–¹å“ç±»æ±‡æ€»å›¾é»˜è®¤æ˜¾ç¤º
      setTimeout(() => {
        switchCategoryTab('æ±‡æ€»åº“å­˜');
      }, 100);
    }

    // ==================== æ„å»ºå“ç±»æ˜ å°„ ====================
    function buildCategoryMap() {
      categoryMap = {};
      allData.forEach(row => {
        const cat = row.category;
        if (!categoryMap[cat]) {
          categoryMap[cat] = [];
        }
        categoryMap[cat].push(row);
      });
    }

    // ==================== æ¸²æŸ“ç»Ÿè®¡å¡ç‰‡ ====================
    function renderStats() {
      const totalSku = allData.length;
      const totalStock = allData.reduce((sum, row) => sum + row.stock, 0);

      // è®¡ç®—ä½åº“å­˜æ•°é‡ï¼ˆåº“å­˜ < å‡ºè´§æ•°*10%ï¼‰
      const lowStockRows = allData.filter(row => {
        const threshold = row.shipQty * 0.1;
        return row.stock < threshold && threshold > 0;
      });
      const lowSkuCount = lowStockRows.length;

      // è®¡ç®—æ¶‰åŠçš„å“ç±»æ•°
      const lowCategories = new Set(lowStockRows.map(row => row.category));
      const lowCatCount = lowCategories.size;

      document.getElementById('mainStats').innerHTML = `
        <div class="stat-card">
          <div class="stat-label">åº“å­˜æ€»æ•°</div>
          <div class="stat-value">${Math.round(totalStock)}</div>
        </div>
        <div class="stat-card clickable" onclick="showLowStockModal()">
          <div class="stat-label">ä½åº“å­˜SKUæ•°</div>
          <div class="stat-value warning">${lowSkuCount}</div>
        </div>
        <div class="stat-card clickable" onclick="showWarningCategoriesModal()">
          <div class="stat-label">é¢„è­¦å“ç±»æ•°</div>
          <div class="stat-value warning">${lowCatCount}</div>
        </div>
      `;
    }

    // ==================== æ¸²æŸ“å“ç±»æ ‡ç­¾ ====================
    function renderCategoryTabs() {
      // å…ˆæ·»åŠ æ±‡æ€»åº“å­˜æŒ‰é’®
      let html = '<button class="category-tab" onclick="switchCategoryTab(\'æ±‡æ€»åº“å­˜\')">æ±‡æ€»åº“å­˜</button>';

      // å†æ·»åŠ å„ä¸ªå“ç±»æŒ‰é’®
      html += CATEGORIES
        .filter(cat => categoryMap[cat] && categoryMap[cat].length > 0)
        .map(cat => `<button class="category-tab" onclick="switchCategoryTab('${cat}')">${cat}</button>`)
        .join('');

      document.getElementById('categoryTabs').innerHTML = html;
    }

    // ==================== åˆ‡æ¢å“ç±»æ ‡ç­¾ ====================
    window.switchCategoryTab = function(cat) {
      currentCategory = cat;
      currentSize = null; // é‡ç½®å°ºç ç­›é€‰

      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('#categoryTabs .category-tab').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent === cat) {
          btn.classList.add('active');
        }
      });

      // æ›´æ–°å³ä¸Šè§’åº“å­˜æ€»æ•°
      renderSelectedCategoryStockTotal(cat);

      // å¦‚æœæ˜¯æ±‡æ€»åº“å­˜ï¼Œæ˜¾ç¤ºä¸‰å“ç±»æ±‡æ€»å›¾è¡¨ï¼Œå¹¶éšè—å°ºç é€‰æ‹©
      if (cat === 'æ±‡æ€»åº“å­˜') {
        document.getElementById('sizeTabs').innerHTML = '';
        showSummaryStockChart();
      } else {
        // æ¸²æŸ“å°ºç é€‰æ‹©æŒ‰é’®
        renderSizeTabs(cat);
        showCategoryStockChart(cat);
      }
    }

    // ==================== æ¸²æŸ“å°ºç ç­›é€‰æŒ‰é’® ====================
    function renderSizeTabs(cat) {
      const sizeTabsContainer = document.getElementById('sizeTabs');

      // æ˜¾ç¤ºå…¨éƒ¨6ä¸ªå°ºç æŒ‰é’®
      let html = '<button class="category-tab active" onclick="switchSizeTab(null)">å…¨éƒ¨å°ºç </button>';
      SIZES.forEach(size => {
        html += `<button class="category-tab" onclick="switchSizeTab('${size}')">${size}</button>`;
      });

      sizeTabsContainer.innerHTML = html;
    }

    // ==================== åˆ‡æ¢å°ºç ç­›é€‰ ====================
    window.switchSizeTab = function(size) {
      currentSize = size;

      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('#sizeTabs .category-tab').forEach(btn => {
        btn.classList.remove('active');
        if ((size === null && btn.textContent === 'å…¨éƒ¨å°ºç ') || btn.textContent === size) {
          btn.classList.add('active');
        }
      });

      showCategoryStockChart(currentCategory, size);
      // å³ä¸Šè§’æ€»åº“å­˜å±•ç¤ºä¸å—å°ºç ç­›é€‰å½±å“ï¼Œä»…æŒ‰å“ç±»æ±‡æ€»
      if (currentCategory) renderSelectedCategoryStockTotal(currentCategory);
    }

    function renderSelectedCategoryStockTotal(cat) {
      const el = document.getElementById('catStockTotal');
      if (!el) return;
      let total = 0;
      if (cat === 'æ±‡æ€»åº“å­˜') {
        total = allData.reduce((s, r) => s + (r.stock || 0), 0);
      } else {
        const list = categoryMap[cat] || [];
        if (currentSize) {
          const sizeKey = String(currentSize).trim().toUpperCase();
          const filtered = list.filter(r => r.size && String(r.size).trim().toUpperCase() === sizeKey);
          total = filtered.reduce((s, r) => s + (r.stock || 0), 0);
        } else {
          total = list.reduce((s, r) => s + (r.stock || 0), 0);
        }
      }
      el.textContent = `åº“å­˜æ€»æ•°ï¼š${Math.round(total)}`;
    }

    // ==================== æ˜¾ç¤ºæ±‡æ€»åº“å­˜å›¾è¡¨ ====================
    function showSummaryStockChart() {
      const targetCategories = ['ç‘œä¼½è£¤', 'è¿ä½“è¡£', 'æ— ç¼'];
      const categoryColors = {
        'ç‘œä¼½è£¤': {
          bg: 'rgba(99, 102, 241, 0.13)',
          border: '#6366f1'
        },
        'è¿ä½“è¡£': {
          bg: 'rgba(236, 72, 153, 0.13)',
          border: '#ec4899'
        },
        'æ— ç¼': {
          bg: 'rgba(14, 165, 233, 0.13)',
          border: '#0ea5e9'
        }
      };

      // æ”¶é›†æ‰€æœ‰SKU-å°ºç ç»„åˆä½œä¸ºXè½´æ ‡ç­¾
      const allSkuSizeMap = {};
      targetCategories.forEach(cat => {
        const data = categoryMap[cat] || [];
        data.forEach(row => {
          const key = `${row.sku}-${row.size}`;
          if (!allSkuSizeMap[key]) {
            allSkuSizeMap[key] = { category: cat, stock: 0 };
          }
          allSkuSizeMap[key].stock += row.stock;
        });
      });

      const labels = Object.keys(allSkuSizeMap);
      const datasets = [];

      // ä¸ºæ¯ä¸ªå“ç±»åˆ›å»ºä¸€ä¸ªæ•°æ®é›†
      targetCategories.forEach(cat => {
        const data = categoryMap[cat] || [];

        // æŒ‰SKU-å°ºç èšåˆåº“å­˜
        const skuMap = {};
        data.forEach(row => {
          const key = `${row.sku}-${row.size}`;
          if (!skuMap[key]) {
            skuMap[key] = 0;
          }
          skuMap[key] += row.stock;
        });

        // ä¸ºæ¯ä¸ªæ ‡ç­¾ç”Ÿæˆå¯¹åº”çš„å€¼ï¼Œå¦‚æœè¯¥å“ç±»æ²¡æœ‰è¿™ä¸ªSKUåˆ™ä¸ºnull
        const values = labels.map(label => {
          if (allSkuSizeMap[label].category === cat || skuMap[label]) {
            return skuMap[label] ? Math.round(skuMap[label]) : null;
          }
          return null;
        });

        if (data.length > 0) {
          datasets.push({
            label: cat,
            data: values,
            fill: false,
            backgroundColor: categoryColors[cat].bg,
            borderColor: categoryColors[cat].border,
            borderWidth: 3,
            pointRadius: 5,
            pointHoverRadius: 7,
            tension: 0.3,
            spanGaps: true // å…è®¸è·³è¿‡nullå€¼
          });
        }
      });

      renderChart(labels, datasets, 'æ±‡æ€»åº“å­˜åˆ†å¸ƒï¼ˆä¸‰å“ç±»å¯¹æ¯”ï¼‰');
    }

    // ==================== æ˜¾ç¤ºå“ç±»åº“å­˜å›¾è¡¨ ====================
    function showCategoryStockChart(cat, size = null) {
      let data = categoryMap[cat] || [];

      // å¦‚æœé€‰æ‹©äº†ç‰¹å®šå°ºç ï¼Œè¿›è¡Œç­›é€‰
      if (size) {
        data = data.filter(row => row.size && row.size.trim().toUpperCase() === size);
      }

      // æŒ‰SKUèšåˆåº“å­˜
      const skuMap = {};
      data.forEach(row => {
        const key = size ? row.sku : `${row.sku || 'æœªçŸ¥'}-${row.size}`;
        if (!skuMap[key]) {
          skuMap[key] = {
            label: key,
            stock: 0
          };
        }
        skuMap[key].stock += row.stock;
      });

      const labels = Object.keys(skuMap);
      const values = labels.map(key => Math.round(skuMap[key].stock));

      const dataset = [{
        label: cat + (size ? ` ${size}ç ` : '') + ' åº“å­˜åˆ†å¸ƒ',
        data: values,
        fill: true,
        backgroundColor: 'rgba(56, 189, 248, 0.13)',
        borderColor: '#2563eb',
        borderWidth: 2,
        pointRadius: 4,
        pointHoverRadius: 6,
        tension: 0.3
      }];

      renderChart(labels, dataset, `${cat}${size ? ' - ' + size + 'ç ' : ''} å“ç±»åº“å­˜åˆ†å¸ƒï¼ˆå…±${data.length}ä¸ªSKU-å°ºç ï¼‰`);
    }

    // ==================== æ¸²æŸ“å›¾è¡¨ ====================
    function renderChart(labels, datasets, title) {
      if (chartInstance) {
        chartInstance.destroy();
      }

      const ctx = document.getElementById('catStockChart').getContext('2d');
      chartInstance = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: title,
              font: { size: 16, weight: 'bold' }
            },
            legend: {
              display: true,
              position: 'top'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return Math.round(value);
                }
              }
            }
          }
        }
      });
    }

    // ==================== æ¸²æŸ“ä½åº“å­˜é¢„è­¦è¡¨ ====================
    let lowStockDataCache = [];
    let lowStockPage = 1;
    let lowStockPageSize = 50; // 0 è¡¨ç¤ºå…¨éƒ¨

    function renderLowStock() {
      const tbody = document.querySelector('#lowStockTable tbody');
      tbody.innerHTML = '';

      // ç­›é€‰ä½åº“å­˜æ•°æ®ï¼ˆç¼“å­˜åˆ°å…¨å±€ï¼‰
      lowStockDataCache = allData.filter(row => {
        const threshold = row.shipQty * 0.1;
        return row.stock < threshold && threshold > 0;
      });

      // æŒ‰å“ç±» + ç´¯è®¡é”€é‡æ’åº
      lowStockDataCache.sort((a, b) => {
        if (a.category !== b.category) {
          return a.category.localeCompare(b.category);
        }
        return b.totalSales - a.totalSales;
      });

      lowStockPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
      renderLowStockPage();

      // ç»‘å®šåˆ†é¡µæ§ä»¶
      const prevBtn = document.getElementById('lowPrevBtn');
      const nextBtn = document.getElementById('lowNextBtn');
      const pageSizeSel = document.getElementById('lowPageSize');
      prevBtn.onclick = () => { if (lowStockPage > 1) { lowStockPage--; renderLowStockPage(); }};
      nextBtn.onclick = () => { const pages = getLowStockTotalPages(); if (lowStockPage < pages) { lowStockPage++; renderLowStockPage(); }};
      pageSizeSel.onchange = (e) => {
        const v = parseInt(e.target.value, 10);
        lowStockPageSize = v === 0 ? 0 : v;
        lowStockPage = 1;
        renderLowStockPage();
      };
    }

    function getLowStockTotalPages() {
      if (lowStockPageSize === 0) return 1;
      return Math.max(1, Math.ceil(lowStockDataCache.length / lowStockPageSize));
    }

    function renderLowStockPage() {
      const tbody = document.querySelector('#lowStockTable tbody');
      tbody.innerHTML = '';
      const total = lowStockDataCache.length;
      const pages = getLowStockTotalPages();
      let pageData = lowStockDataCache;
      if (lowStockPageSize !== 0) {
        const start = (lowStockPage - 1) * lowStockPageSize;
        pageData = lowStockDataCache.slice(start, start + lowStockPageSize);
      }

      if (total === 0) {
        tbody.innerHTML = '<tr><td colspan="11" style="padding:20px;color:#64748b;">æš‚æ— ä½åº“å­˜é¢„è­¦</td></tr>';
      } else {
        pageData.forEach(row => {
          const threshold = Math.round(row.shipQty * 0.1);
          const imageHtml = renderRowImageOrSwatch(row);
          const tr = tbody.insertRow();
          tr.className = 'lowstock';
          tr.innerHTML = `
            <td style=\"text-align:center;\">${imageHtml}</td>
            <td><strong>${row.category}</strong></td>
            <td>${row.sku}</td>
            <td>${row.size || '-'}</td>
            <td>${row.productName || '-'}</td>
            <td><strong>${Math.round(row.stock)}</strong></td>
            <td>${Math.round(row.shipQty)}</td>
            <td>${threshold}</td>
            <td>${Math.round(row.dailySales)}</td>
            <td>${Math.round(row.totalSales)}</td>
            <td><span class=\"warn-icon\">âš ï¸</span> ä½åº“å­˜</td>
          `;
        });
      }

      const info = document.getElementById('lowPageInfo');
      info.textContent = `ç¬¬ ${pages === 0 ? 0 : lowStockPage} / ${pages} é¡µï¼ˆå…± ${total} æ¡ï¼‰`;
    }

    // ==================== æ¸²æŸ“çƒ­é”€TOP5 ====================
    function renderTopSku() {
      const container = document.getElementById('topSkuList');
      let html = '';

      CATEGORIES.forEach(cat => {
        const data = categoryMap[cat] || [];
        if (data.length === 0) return;

        // æŒ‰ç´¯è®¡é”€é‡æ’åº
        const sorted = data.slice().sort((a, b) => b.totalSales - a.totalSales);
        const top5 = sorted.slice(0, 5);

        html += `<div class="top-section">`;
        html += `<div class="top-category-title">${cat} çƒ­é”€TOP 5</div>`;
        html += `<div class="top-list">`;

        top5.forEach((row, index) => {
          // ç”Ÿæˆå›¾ç‰‡/è‰²å—
          const imageHtml = renderRowImageOrSwatch(row, 'large');

          html += `
            <div class="top-list-item">
              <div class="top-rank">${index + 1}</div>
              ${imageHtml}
              <div class="top-sku">${row.sku || 'æœªçŸ¥SKU'}</div>
              <div class="top-size">å°ºç : ${row.size || '-'}</div>
              <div class="top-name">${row.productName || '-'}</div>
              <div class="top-stat">
                <div class="top-stat-item">
                  <div class="top-stat-label">åº“å­˜</div>
                  <div class="top-stat-value">${Math.round(row.stock)}</div>
                </div>
                <div class="top-stat-item">
                  <div class="top-stat-label">ç´¯è®¡é”€é‡</div>
                  <div class="top-stat-value">${Math.round(row.totalSales)}</div>
                </div>
                <div class="top-stat-item">
                  <div class="top-stat-label">æ—¥é”€</div>
                  <div class="top-stat-value">${Math.round(row.dailySales)}</div>
                </div>
              </div>
            </div>
          `;
        });

        html += `</div></div>`;
      });

      container.innerHTML = html;
    }

    // ==================== æ¸²æŸ“åŸå§‹æ˜ç»†è¡¨ ====================
    function renderStockDetail() {
      const table = document.getElementById('stockDetailTable');

      if (allData.length === 0) {
        table.innerHTML = '<tbody><tr><td style="padding:20px;">æš‚æ— æ•°æ®</td></tr></tbody>';
        return;
      }

      // æŒ‰SKUåˆ†ç»„
      const skuGroups = {};
      allData.forEach(row => {
        const key = row.sku;
        if (!skuGroups[key]) {
          skuGroups[key] = {
            category: row.category,
            sheetName: row.sheetName,
            sku: row.sku,
            productName: row.productName,
            sizes: []
          };
        }
        skuGroups[key].sizes.push(row);
      });

      // å°ºç æ’åºé¡ºåº
      const sizeOrder = ['XS', 'S', 'M', 'L', 'XL', 'XXL'];

      // å¯¹æ¯ä¸ªSKUçš„å°ºç è¿›è¡Œæ’åº
      Object.values(skuGroups).forEach(group => {
        group.sizes.sort((a, b) => {
          const indexA = sizeOrder.indexOf(a.size);
          const indexB = sizeOrder.indexOf(b.size);
          return (indexA === -1 ? 999 : indexA) - (indexB === -1 ? 999 : indexB);
        });
        // è®¡ç®—è¯¥SKUçš„æ€»ç´¯è®¡é”€é‡ï¼ˆç”¨äºæ’åºï¼‰
        group.totalSalesSum = group.sizes.reduce((sum, s) => sum + s.totalSales, 0);
        // ä¿å­˜è¯¥SKUçš„å›¾ç‰‡URLï¼ˆä½¿ç”¨ç¬¬ä¸€ä¸ªå°ºç çš„å›¾ç‰‡ï¼‰
        group.imageUrl = group.sizes[0].imageUrl || null;
      });

      // æŒ‰å“ç±»æ’åºï¼šç‘œä¼½è£¤ã€è¿ä½“è¡£ã€æ— ç¼ã€å…¶ä»–
      const categoryOrder = ['ç‘œä¼½è£¤', 'è¿ä½“è¡£', 'æ— ç¼', 'å…¶ä»–'];
      const sortedGroups = Object.values(skuGroups).sort((a, b) => {
        const indexA = categoryOrder.indexOf(a.category);
        const indexB = categoryOrder.indexOf(b.category);
        const orderA = indexA === -1 ? 999 : indexA;
        const orderB = indexB === -1 ? 999 : indexB;

        if (orderA !== orderB) {
          return orderA - orderB;
        }

        // åŒå“ç±»å†…æŒ‰ç´¯è®¡é”€é‡æ€»å’Œæ’åº
        return b.totalSalesSum - a.totalSalesSum;
      });

      let html = `
        <thead>
          <tr>
            <th>å›¾ç‰‡</th>
            <th>å“ç±»</th>
            <th>å·¥ä½œè¡¨</th>
            <th>SKU</th>
            <th>å°ºç </th>
            <th>å•†å“åç§°</th>
            <th>å‡ºè´§æ•°</th>
            <th>åº“å­˜æ•°é‡</th>
            <th>æ—¥é”€æ•°é‡</th>
            <th>ç´¯è®¡é”€é‡</th>
          </tr>
        </thead>
        <tbody>
      `;

      let otherGroupCount = 0;

      sortedGroups.forEach((group, groupIndex) => {
        const skuId = `sku_${groupIndex}`;
        const subCat = (group.category === 'æ— ç¼') ? (detectSeamlessSubCategory(group.productName, group.sheetName) || 'æ— ç¼') : group.category;

        // è®¡ç®—è¯¥SKUæ‰€æœ‰å°ºç çš„æ±‡æ€»
        const totalShipQty = group.sizes.reduce((sum, s) => sum + s.shipQty, 0);
        const totalStock = group.sizes.reduce((sum, s) => sum + s.stock, 0);
        const totalDailySales = group.sizes.reduce((sum, s) => sum + s.dailySales, 0);
        const totalSales = group.sizes.reduce((sum, s) => sum + s.totalSales, 0);

        // å¦‚æœæ˜¯"å…¶ä»–"ç±»åˆ«
        if (group.category === 'å…¶ä»–') {
          if (otherGroupCount === 0) {
            const otherGroups = sortedGroups.filter(g => g.category === 'å…¶ä»–');
            html += `
              <tr class="collapsible-row" onclick="toggleOtherCategory()">
                <td colspan="10">
                  <span class="collapse-icon" id="otherCollapseIcon">â–¶</span>
                  <strong>å…¶ä»– (${otherGroups.length}ä¸ªSKU)</strong>
                </td>
              </tr>
            `;
          }

          // ç”Ÿæˆå›¾ç‰‡/è‰²å—
          const imageHtml = renderRowImageOrSwatch({
            category: group.category,
            sheetName: group.sheetName,
            productName: group.productName,
            sku: group.sku,
            imageUrl: group.imageUrl
          });

          // ä¸»è¡Œï¼ˆSKUæ±‡æ€»ï¼‰- å…¶ä»–ç±»åˆ«
          html += `
            <tr class="collapsible-row other-row collapsed" onclick="toggleSkuRow('${skuId}')" data-category="${group.category}" data-sub="${subCat}" data-group="${skuId}">
              <td style="text-align:center;">${imageHtml}</td>
              <td><strong>${group.category}</strong></td>
              <td>${group.sheetName}</td>
              <td colspan="2">
                <span class="collapse-icon" id="${skuId}_icon">â–¶</span>
                <strong>${group.sku}</strong> <span style="color: #64748b; font-size: 0.9em;">(${group.sizes.length}ä¸ªå°ºç )</span>
              </td>
              <td><strong>${group.productName || '-'}</strong></td>
              <td><strong>${Math.round(totalShipQty)}</strong></td>
              <td><strong>${Math.round(totalStock)}</strong></td>
              <td><strong>${Math.round(totalDailySales)}</strong></td>
              <td><strong>${Math.round(totalSales)}</strong></td>
            </tr>
          `;

          // å°ºç æ˜ç»†è¡Œ - å…¶ä»–ç±»åˆ«
          group.sizes.forEach(sizeRow => {
            html += `
              <tr class="size-row other-row collapsed ${skuId}-size collapsed" style="background: #f8fafc;" data-category="${group.category}" data-sub="${subCat}" data-group="${skuId}">
                <td></td>
                <td></td>
                <td></td>
                <td style="padding-left: 30px; color: #64748b;">â””â”€</td>
                <td><span style="background: #e0e7ff; color: #4338ca; padding: 2px 8px; border-radius: 4px; font-size: 0.85em; font-weight: 600;">${sizeRow.size || '-'}</span></td>
                <td style="color: #64748b;">${sizeRow.productName || '-'}</td>
                <td>${Math.round(sizeRow.shipQty)}</td>
                <td>${Math.round(sizeRow.stock)}</td>
                <td>${Math.round(sizeRow.dailySales)}</td>
                <td>${Math.round(sizeRow.totalSales)}</td>
              </tr>
            `;
          });

          otherGroupCount++;
        } else {
          // ç”Ÿæˆå›¾ç‰‡/è‰²å—
          const imageHtml = renderRowImageOrSwatch({
            category: group.category,
            sheetName: group.sheetName,
            productName: group.productName,
            sku: group.sku,
            imageUrl: group.imageUrl
          });

          // ä¸»è¡Œï¼ˆSKUæ±‡æ€»ï¼‰- æ­£å¸¸ç±»åˆ«
          html += `
            <tr class="collapsible-row" onclick="toggleSkuRow('${skuId}')" data-category="${group.category}" data-sub="${subCat}" data-group="${skuId}">
              <td style="text-align:center;">${imageHtml}</td>
              <td><strong>${group.category}</strong></td>
              <td>${group.sheetName}</td>
              <td colspan="2">
                <span class="collapse-icon" id="${skuId}_icon">â–¶</span>
                <strong>${group.sku}</strong> <span style="color: #64748b; font-size: 0.9em;">(${group.sizes.length}ä¸ªå°ºç )</span>
              </td>
              <td><strong>${group.productName || '-'}</strong></td>
              <td><strong>${Math.round(totalShipQty)}</strong></td>
              <td><strong>${Math.round(totalStock)}</strong></td>
              <td><strong>${Math.round(totalDailySales)}</strong></td>
              <td><strong>${Math.round(totalSales)}</strong></td>
            </tr>
          `;

          // å°ºç æ˜ç»†è¡Œ - æ­£å¸¸ç±»åˆ«
          group.sizes.forEach(sizeRow => {
            html += `
              <tr class="size-row ${skuId}-size collapsed" style="background: #f8fafc;" data-category="${group.category}" data-sub="${subCat}" data-group="${skuId}">
                <td></td>
                <td></td>
                <td></td>
                <td style="padding-left: 30px; color: #64748b;">â””â”€</td>
                <td><span style="background: #e0e7ff; color: #4338ca; padding: 2px 8px; border-radius: 4px; font-size: 0.85em; font-weight: 600;">${sizeRow.size || '-'}</span></td>
                <td style="color: #64748b;">${sizeRow.productName || '-'}</td>
                <td>${Math.round(sizeRow.shipQty)}</td>
                <td>${Math.round(sizeRow.stock)}</td>
                <td>${Math.round(sizeRow.dailySales)}</td>
                <td>${Math.round(sizeRow.totalSales)}</td>
              </tr>
            `;
          });
        }
      });

      html += '</tbody>';
      table.innerHTML = html;
    }

    // ==================== æ— ç¼å­ç±»ç­›é€‰/èšåˆï¼ˆæ–°å¢ï¼‰ ====================
    let seamlessFilter = 'all'; // 'all' | 'leggings' | 'bra'

    function bindSeamlessButtons() {
      const box = document.getElementById('seamless-buttons');
      if (!box) return;
      // ä»…å½“å­˜åœ¨æ— ç¼æ•°æ®æ—¶æ˜¾ç¤º
      const hasSeamless = (categoryMap['æ— ç¼'] || []).length > 0;
      box.style.display = hasSeamless ? '' : 'none';
      const html = [
        '<button id="btnSeamAll" class="category-tab">å…¨éƒ¨</button>',
        '<button id="btnSeamLeggings" class="category-tab">æ— ç¼-ç‘œä¼½è£¤</button>',
        '<button id="btnSeamBra" class="category-tab">æ— ç¼-æ–‡èƒ¸</button>'
      ].join('');
      box.innerHTML = html;

      const allBtn = document.getElementById('btnSeamAll');
      const lgBtn = document.getElementById('btnSeamLeggings');
      const brBtn = document.getElementById('btnSeamBra');

      const setActive = (key) => {
        seamlessFilter = key;
        [allBtn, lgBtn, brBtn].forEach(b => b && b.classList.remove('active'));
        if (key === 'all' && allBtn) allBtn.classList.add('active');
        if (key === 'leggings' && lgBtn) lgBtn.classList.add('active');
        if (key === 'bra' && brBtn) brBtn.classList.add('active');
        // åˆ‡åˆ°æ— ç¼å¤§ç±»ï¼Œç¡®ä¿è¡¨æ ¼åŸºç¡€é›†æ­£ç¡®
        applyCategoryFilter('æ— ç¼');
        // è¡¨æ ¼è¡ŒæŒ‰æ— ç¼å­ç±»è¿‡æ»¤
        applySeamlessSubFilter();
        // æ±‡æ€»å¡ä½äºæ›²çº¿å›¾ä¸Šæ–¹
        renderSeamlessAggregatesForCurrent();
        // æ¸²æŸ“æ— ç¼å­ç±»SKUæ›²çº¿
        renderSeamlessSkuChartForCurrent();
      };

      if (allBtn) allBtn.onclick = () => setActive('all');
      if (lgBtn) lgBtn.onclick = () => setActive('leggings');
      if (brBtn) brBtn.onclick = () => setActive('bra');

      // åˆå§‹æ€ï¼šä»…é«˜äº®ä½†ä¸åˆ‡æ¢ç±»åˆ«
      [allBtn, lgBtn, brBtn].forEach(b => b && b.classList.remove('active'));
      if (allBtn) allBtn.classList.add('active');
    }

    function renderSeamlessSkuChartForCurrent() {
      const chartBox = document.getElementById('category-chart-box');
      const dailyCanvasBox = document.getElementById('cat-all-daily-box');
      const rowsAll = categoryMap['æ— ç¼'] || [];
      let rows = rowsAll;
      let title = 'æ— ç¼-å…¨éƒ¨';
      if (seamlessFilter === 'leggings') {
        rows = rowsAll.filter(r => detectSeamlessSubCategory(r.productName, r.sheetName) === 'æ— ç¼ç‘œä¼½è£¤');
        title = 'æ— ç¼-ç‘œä¼½è£¤';
      } else if (seamlessFilter === 'bra') {
        rows = rowsAll.filter(r => detectSeamlessSubCategory(r.productName, r.sheetName) === 'æ— ç¼æ–‡èƒ¸');
        title = 'æ— ç¼-æ–‡èƒ¸';
      }

      // èšåˆåˆ°SKUå±‚
      const skuAgg = {};
      const skuMeta = {};
      rows.forEach(r => {
        if (!skuAgg[r.sku]) skuAgg[r.sku] = { totalSales: 0, dailySales: 0 };
        skuAgg[r.sku].totalSales += (r.totalSales || 0);
        skuAgg[r.sku].dailySales += (r.dailySales || 0);
        if (!skuMeta[r.sku]) {
          const match = String(r.sku || '').match(/-([^\-]+)$/);
          const color = match ? match[1] : '';
          skuMeta[r.sku] = { name: r.productName || r.sku, color };
        }
      });
      const skus = Object.keys(skuAgg);
      const labels = skus.map(k => skuMeta[k].color ? `${skuMeta[k].name}-${skuMeta[k].color}` : skuMeta[k].name);
      const totalSeries = skus.map(k => Math.round(skuAgg[k].totalSales));
      const dailySeries = skus.map(k => Math.round(skuAgg[k].dailySales));

      const ctx = document.getElementById('categorySkuChart').getContext('2d');
      if (categorySkuChartInstance) categorySkuChartInstance.destroy();
      if (categorySkuChartDailyInstance) { categorySkuChartDailyInstance.destroy(); categorySkuChartDailyInstance = null; }
      categorySkuChartInstance = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [
          { label: `${title} ç´¯è®¡é”€é‡`, data: totalSeries, borderColor: '#2563eb', backgroundColor: 'rgba(37,99,235,0.12)', tension: 0.3, fill: true, pointRadius: 3 },
          { label: `${title} æ—¥é”€`, data: dailySeries, borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.12)', tension: 0.3, fill: true, pointRadius: 3 }
        ]},
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' }, title: { display: true, text: `${title} SKU é”€é‡æ›²çº¿` } }, scales: { y: { beginAtZero: true } } }
      });
      chartBox.style.display = labels.length ? 'flex' : 'none';
      dailyCanvasBox.style.display = 'none';
    }

    // ç›´æ¥æŒ‰åˆ†ç±»åæ¸²æŸ“å­ç±»æ›²çº¿ï¼ˆä¾›ä¸»æŒ‰é’®è¡Œç›´è¾¾è°ƒç”¨ï¼‰
    function renderSeamlessSkuChartForCat(cat) {
      if (cat === 'æ— ç¼-ç‘œä¼½è£¤') {
        seamlessFilter = 'leggings';
        renderSeamlessSkuChartForCurrent();
      } else if (cat === 'æ— ç¼-æ–‡èƒ¸') {
        seamlessFilter = 'bra';
        renderSeamlessSkuChartForCurrent();
      } else {
        seamlessFilter = 'all';
        renderSeamlessSkuChartForCurrent();
      }
    }

    function applySeamlessSubFilter() {
      const rows = document.querySelectorAll('#stockDetailTable tbody tr');
      rows.forEach(tr => {
        const cat = tr.getAttribute('data-category');
        const sub = tr.getAttribute('data-sub') || '';
        if (!cat) return;
        if (seamlessFilter === 'all') {
          tr.style.display = '';
          return;
        }
        if (cat !== 'æ— ç¼') {
          // éæ— ç¼ä¸å—è¯¥ç­›é€‰å½±å“
          tr.style.display = '';
          return;
        }
        if (seamlessFilter === 'leggings') {
          tr.style.display = (sub === 'æ— ç¼ç‘œä¼½è£¤') ? '' : 'none';
        } else if (seamlessFilter === 'bra') {
          tr.style.display = (sub === 'æ— ç¼æ–‡èƒ¸') ? '' : 'none';
        }
      });
    }

    function computeAggregatesForRows(rows) {
      const num = (v) => (typeof v === 'number' ? v : parseFloat(String(v).replace(/,/g, '')) || 0);
      let totalSales = 0;
      let totalStock = 0;
      let totalDaily = 0;
      let totalRefund = 0;
      const colorSales = new Map();
      rows.forEach(r => {
        totalSales += num(r.totalSales);
        totalStock += num(r.stock);
        totalDaily += num(r.dailySales);
        totalRefund += num(r.refundQty);
        const m = String(r.sku || '').match(/-([^\-]+)$/);
        const color = m ? m[1] : '';
        if (color) colorSales.set(color, (colorSales.get(color) || 0) + num(r.totalSales));
      });
      const topColors = Array.from(colorSales.entries()).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([color, sales])=>({color, sales: Math.round(sales)}));
      return { totalSales: Math.round(totalSales), totalStock: Math.round(totalStock), totalDaily: Math.round(totalDaily), totalRefund: Math.round(totalRefund), topColors };
    }

    function renderSeamlessAggregates(agg, title) {
      const el = document.getElementById('seamless-aggregates');
      if (!el) return;
      const colorCodes = agg.topColors.map(c => c.color).join(' ');
      el.innerHTML = `
        <div class="stat-card"><div class="stat-label">${title} - æ€»åº“å­˜æ•°</div><div class="stat-value">${agg.totalStock}</div></div>
        <div class="stat-card"><div class="stat-label">${title} - æ€»ç´¯è®¡é”€é‡</div><div class="stat-value">${agg.totalSales}</div></div>
        <div class="stat-card"><div class="stat-label">${title} - æ€»æ—¥é”€</div><div class="stat-value">${agg.totalDaily}</div></div>
        <div class="stat-card"><div class="stat-label">${title} - æ€»é€€æ¬¾é‡</div><div class="stat-value">${agg.totalRefund}</div></div>
        <div class="stat-card"><div class="stat-label">${title} - çƒ­é”€è‰²å·</div><div class="stat-value">${colorCodes || '-'}</div></div>
      `;
      el.style.display = '';
    }

    function renderSeamlessAggregatesForCurrent() {
      const el = document.getElementById('seamless-aggregates');
      if (!el) return;
      const hasSeamless = (categoryMap['æ— ç¼'] || []).length > 0;
      if (!hasSeamless) { el.style.display = 'none'; return; }
      let rows = categoryMap['æ— ç¼'] || [];
      if (seamlessFilter === 'leggings') {
        rows = rows.filter(r => detectSeamlessSubCategory(r.productName, r.sheetName) === 'æ— ç¼ç‘œä¼½è£¤');
        renderSeamlessAggregates(computeAggregatesForRows(rows), 'æ— ç¼-ç‘œä¼½è£¤');
      } else if (seamlessFilter === 'bra') {
        rows = rows.filter(r => detectSeamlessSubCategory(r.productName, r.sheetName) === 'æ— ç¼æ–‡èƒ¸');
        renderSeamlessAggregates(computeAggregatesForRows(rows), 'æ— ç¼-æ–‡èƒ¸');
      } else {
        // å…¨éƒ¨ï¼šæ˜¾ç¤ºæ— ç¼æ•´ä½“
        renderSeamlessAggregates(computeAggregatesForRows(rows), 'æ— ç¼-å…¨éƒ¨');
      }
    }

    // æ ¹æ®åˆ†ç±»åç§°æ¸²æŸ“æ— ç¼èšåˆï¼ˆä¾›ä¸»æŒ‰é’®è¡Œç›´è¾¾è°ƒç”¨ï¼‰
    function renderSeamlessAggregatesForCurrentByCat(cat) {
      const hasSeamless = (categoryMap['æ— ç¼'] || []).length > 0;
      const el = document.getElementById('seamless-aggregates');
      if (!el) return;
      if (!hasSeamless) { el.style.display = 'none'; return; }
      let rows = categoryMap['æ— ç¼'] || [];
      if (cat === 'æ— ç¼-ç‘œä¼½è£¤') {
        rows = rows.filter(r => detectSeamlessSubCategory(r.productName, r.sheetName) === 'æ— ç¼ç‘œä¼½è£¤');
        renderSeamlessAggregates(computeAggregatesForRows(rows), 'æ— ç¼-ç‘œä¼½è£¤');
      } else if (cat === 'æ— ç¼-æ–‡èƒ¸') {
        rows = rows.filter(r => detectSeamlessSubCategory(r.productName, r.sheetName) === 'æ— ç¼æ–‡èƒ¸');
        renderSeamlessAggregates(computeAggregatesForRows(rows), 'æ— ç¼-æ–‡èƒ¸');
      } else {
        renderSeamlessAggregates(computeAggregatesForRows(rows), 'æ— ç¼-å…¨éƒ¨');
      }
    }

    // ==================== æ˜ç»†åˆ†ç±»ç­›é€‰/æ±‡æ€»/æ›²çº¿ ====================
    function renderCategoryButtons() {
      const container = document.getElementById('category-buttons');
      if (!container) return;
      const cats = ['ç‘œä¼½è£¤','è¿ä½“è¡£','æ— ç¼'];
      const mainBtns = ['å…¨éƒ¨', ...cats]
        .map(c => `<button class="category-tab" data-cat="${c}">${c}</button>`)
        .join('');
      const seamlessSubBtns = [
        `<button class="category-tab" data-cat="æ— ç¼-ç‘œä¼½è£¤">æ— ç¼-ç‘œä¼½è£¤</button>`,
        `<button class="category-tab" data-cat="æ— ç¼-æ–‡èƒ¸">æ— ç¼-æ–‡èƒ¸</button>`
      ].join('');
      container.innerHTML = mainBtns + seamlessSubBtns;
      container.querySelectorAll('button').forEach(btn => {
        btn.onclick = () => applyCategoryFilter(btn.getAttribute('data-cat'));
      });
    }

    function applyCategoryFilter(cat) {
      const rows = document.querySelectorAll('#stockDetailTable tbody tr');
      const isAll = (cat === 'å…¨éƒ¨');

      // æ— ç¼å­ç±»ç‰¹æ®Šå¤„ç†
      const isSeamLeg = (cat === 'æ— ç¼-ç‘œä¼½è£¤');
      const isSeamBra = (cat === 'æ— ç¼-æ–‡èƒ¸');
      const isSeamAll = (cat === 'æ— ç¼');

      if (isSeamLeg || isSeamBra) {
        // ä»…æ˜¾ç¤ºæ— ç¼ï¼Œä¸”æŒ‰å­ç±»è¿‡æ»¤
        rows.forEach(tr => {
          const rowCat = tr.getAttribute('data-category');
          const sub = tr.getAttribute('data-sub') || '';
          const ok = rowCat === 'æ— ç¼' && ((isSeamLeg && sub === 'æ— ç¼ç‘œä¼½è£¤') || (isSeamBra && sub === 'æ— ç¼æ–‡èƒ¸'));
          tr.style.display = ok ? '' : 'none';
        });
      } else {
        // å¸¸è§„ï¼šå…¨éƒ¨æˆ–å¤§ç±»
        rows.forEach(tr => {
          const rowCat = tr.getAttribute('data-category');
          if (!rowCat) return;
          tr.style.display = isAll ? '' : (rowCat === cat ? '' : 'none');
        });
      }

      // æ›´æ–°æŒ‰é’®æ¿€æ´»æ€
      document.querySelectorAll('#category-buttons .category-tab').forEach(btn => btn.classList.remove('active'));
      const activeBtn = Array.from(document.querySelectorAll('#category-buttons .category-tab')).find(b => b.textContent === cat);
      if (activeBtn) activeBtn.classList.add('active');

      const chartBox = document.getElementById('category-chart-box');
      const dailyCanvasBox = document.getElementById('cat-all-daily-box');
      const catSummary = document.getElementById('category-summary');
      const seamAgg = document.getElementById('seamless-aggregates');

      if (isSeamLeg || isSeamBra) {
        // éšè—é€šç”¨æ±‡æ€»ï¼Œåªæ˜¾ç¤ºæ— ç¼èšåˆ + å­ç±»æ›²çº¿
        if (catSummary) catSummary.style.display = 'none';
        renderSeamlessAggregatesForCurrentByCat(cat);
        renderSeamlessSkuChartForCat(cat);
        chartBox.style.display = 'flex';
        dailyCanvasBox.style.display = 'none';
        if (seamAgg) seamAgg.style.display = '';
      } else if (isSeamAll) {
        if (catSummary) catSummary.style.display = 'none';
        // æ— ç¼å¤§ç±»ï¼šæ˜¾ç¤ºâ€œæ— ç¼-å…¨éƒ¨â€èšåˆä¸æ›²çº¿
        renderSeamlessAggregatesForCurrentByCat('æ— ç¼');
        renderSeamlessSkuChartForCat('æ— ç¼');
        chartBox.style.display = 'flex';
        dailyCanvasBox.style.display = 'none';
        if (seamAgg) seamAgg.style.display = '';
      } else if (isAll) {
        if (seamAgg) seamAgg.style.display = 'none';
        renderAllSummary();
        renderAllCompareCharts();
        chartBox.style.display = 'flex';
        dailyCanvasBox.style.display = '';
        if (catSummary) catSummary.style.display = '';
      } else {
        if (seamAgg) seamAgg.style.display = 'none';
        renderCategorySummary(cat);
        renderCategorySkuChart(cat);
        chartBox.style.display = 'flex';
        dailyCanvasBox.style.display = 'none';
        if (catSummary) catSummary.style.display = '';
      }
    }

    function renderCategorySummary(cat) {
      const box = document.getElementById('category-summary');
      const data = categoryMap[cat] || [];
      const stock = data.reduce((s, r) => s + (r.stock || 0), 0);
      const daily = data.reduce((s, r) => s + (r.dailySales || 0), 0);
      const cum = data.reduce((s, r) => s + (r.totalSales || 0), 0);
      const refund = data.reduce((s, r) => s + (r.refundQty || 0), 0);
      // ç»Ÿè®¡çƒ­é”€å°ºç /é¢œè‰²ä»£ç ï¼šæŒ‰SKUæœ«æ®µèšåˆç´¯è®¡é”€é‡ï¼Œå–å‰ä¸‰ï¼Œå»é‡
      const codeToSales = {};
      data.forEach(r => {
        const m = String(r.sku || '').match(/-([^\-]+)$/);
        const code = m ? m[1] : '';
        if (!code) return;
        codeToSales[code] = (codeToSales[code] || 0) + (r.totalSales || 0);
      });
      const hotCodes = Object.entries(codeToSales)
        .sort((a,b) => b[1]-a[1])
        .slice(0,3)
        .map(([code]) => code)
        .join(' ');
      if (cat === 'ç‘œä¼½è£¤' || cat === 'è¿ä½“è¡£') {
        box.innerHTML = `
          <div class="stat-card"><div class="stat-label">æ€»åº“å­˜æ•°</div><div class="stat-value">${Math.round(stock)}</div></div>
          <div class="stat-card"><div class="stat-label">æ€»ç´¯è®¡é”€é‡</div><div class="stat-value">${Math.round(cum)}</div></div>
          <div class="stat-card"><div class="stat-label">æ€»æ—¥é”€</div><div class="stat-value">${Math.round(daily)}</div></div>
          <div class="stat-card"><div class="stat-label">æ€»é€€æ¬¾é‡</div><div class="stat-value">${Math.round(refund)}</div></div>
          <div class="stat-card"><div class="stat-label">çƒ­é”€è‰²å·</div><div class="stat-value">${hotCodes || '-'}</div></div>
        `;
      } else {
        // å…¨éƒ¨/å…¶ä»–ä¿æŒåŸå››å—
        box.innerHTML = `
          <div class="stat-card"><div class="stat-label">æ€»åº“å­˜æ•°</div><div class="stat-value">${Math.round(stock)}</div></div>
          <div class="stat-card"><div class="stat-label">æ€»ç´¯è®¡é”€é‡</div><div class="stat-value">${Math.round(cum)}</div></div>
          <div class="stat-card"><div class="stat-label">æ€»æ—¥é”€</div><div class="stat-value">${Math.round(daily)}</div></div>
          <div class="stat-card"><div class="stat-label">çƒ­é”€è‰²å·</div><div class="stat-value">${hotCodes || '-'}</div></div>
        `;
      }
      box.style.display = '';
    }

    let categorySkuChartInstance = null;
    let categorySkuChartDailyInstance = null;
    function renderCategorySkuChart(cat) {
      const data = categoryMap[cat] || [];
      // èšåˆåˆ°SKUå±‚ï¼ˆåˆå¹¶æ‰€æœ‰å°ºç ï¼‰
      const skuAgg = {};
      const skuMeta = {}; // sku -> { name, color }
      data.forEach(r => {
        if (!skuAgg[r.sku]) skuAgg[r.sku] = { totalSales: 0, dailySales: 0 };
        skuAgg[r.sku].totalSales += (r.totalSales || 0);
        skuAgg[r.sku].dailySales += (r.dailySales || 0);
        if (!skuMeta[r.sku]) {
          // æå–é¢œè‰²ä»£ç ï¼šSKU æœ€åä¸€ä¸ª '-' åçš„æ®µ
          const match = String(r.sku || '').match(/-([^\-]+)$/);
          const color = match ? match[1] : '';
          skuMeta[r.sku] = { name: r.productName || r.sku, color: color };
        }
      });
      const skus = Object.keys(skuAgg);
      const labels = skus.map(k => skuMeta[k].color ? `${skuMeta[k].name}-${skuMeta[k].color}` : skuMeta[k].name);
      const totalSeries = skus.map(k => Math.round(skuAgg[k].totalSales));
      const dailySeries = skus.map(k => Math.round(skuAgg[k].dailySales));

      const ctx = document.getElementById('categorySkuChart').getContext('2d');
      if (categorySkuChartInstance) categorySkuChartInstance.destroy();
      if (categorySkuChartDailyInstance) { categorySkuChartDailyInstance.destroy(); categorySkuChartDailyInstance = null; }
      categorySkuChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: `${cat} ç´¯è®¡é”€é‡`, data: totalSeries, borderColor: '#2563eb', backgroundColor: 'rgba(37,99,235,0.12)', tension: 0.3, fill: true, pointRadius: 3 },
            { label: `${cat} æ—¥é”€`, data: dailySeries, borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.12)', tension: 0.3, fill: true, pointRadius: 3 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'top' }, title: { display: true, text: `${cat} SKU é”€é‡æ›²çº¿` } },
          scales: { y: { beginAtZero: true } }
        }
      });
      document.getElementById('category-chart-box').style.display = labels.length ? '' : 'none';
    }

    function renderAllSummary() {
      const box = document.getElementById('category-summary');
      const stock = allData.reduce((s, r) => s + (r.stock || 0), 0);
      const daily = allData.reduce((s, r) => s + (r.dailySales || 0), 0);
      const cum = allData.reduce((s, r) => s + (r.totalSales || 0), 0);
      const codeToSales = {};
      allData.forEach(r => {
        const m = String(r.sku || '').match(/-([^\-]+)$/);
        const code = m ? m[1] : '';
        if (!code) return;
        codeToSales[code] = (codeToSales[code] || 0) + (r.totalSales || 0);
      });
      const hotCodes = Object.entries(codeToSales)
        .sort((a,b) => b[1]-a[1])
        .slice(0,3)
        .map(([code]) => code)
        .join(' ');
      box.innerHTML = `
        <div class="stat-card"><div class="stat-label">æ€»åº“å­˜æ•°</div><div class="stat-value">${Math.round(stock)}</div></div>
        <div class="stat-card"><div class="stat-label">æ€»ç´¯è®¡é”€é‡</div><div class="stat-value">${Math.round(cum)}</div></div>
        <div class="stat-card"><div class="stat-label">æ€»æ—¥é”€</div><div class="stat-value">${Math.round(daily)}</div></div>
        <div class="stat-card"><div class="stat-label">çƒ­é”€è‰²å·</div><div class="stat-value">${hotCodes || '-'}</div></div>
      `;
      box.style.display = '';
    }

    function renderAllCompareCharts() {
      const cats = ['ç‘œä¼½è£¤','è¿ä½“è¡£','æ— ç¼'];
      const labels = cats;
      const cum = cats.map(c => (categoryMap[c] || []).reduce((s, r) => s + (r.totalSales || 0), 0));
      const daily = cats.map(c => (categoryMap[c] || []).reduce((s, r) => s + (r.dailySales || 0), 0));

      // ç´¯è®¡é”€é‡å¯¹æ¯”
      const ctx1 = document.getElementById('categorySkuChart').getContext('2d');
      if (categorySkuChartInstance) categorySkuChartInstance.destroy();
      categorySkuChartInstance = new Chart(ctx1, {
        type: 'line',
        data: { labels, datasets: [ { label: 'ç´¯è®¡é”€é‡', data: cum, borderColor: '#2563eb', backgroundColor: 'rgba(37,99,235,0.12)', tension: 0.3, fill: true, pointRadius: 4 } ] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' }, title: { display: true, text: 'ä¸‰å“ç±»ç´¯è®¡é”€é‡å¯¹æ¯”' } }, scales: { y: { beginAtZero: true } } }
      });

      // æ—¥é”€å¯¹æ¯”
      const dailyCanvas = document.getElementById('categorySkuChartDaily');
      const ctx2 = dailyCanvas.getContext('2d');
      if (categorySkuChartDailyInstance) categorySkuChartDailyInstance.destroy();
      categorySkuChartDailyInstance = new Chart(ctx2, {
        type: 'line',
        data: { labels, datasets: [ { label: 'æ—¥é”€', data: daily, borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.12)', tension: 0.3, fill: true, pointRadius: 4 } ] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' }, title: { display: true, text: 'ä¸‰å“ç±»æ—¥é”€å¯¹æ¯”' } }, scales: { y: { beginAtZero: true } } }
      });

      document.getElementById('category-chart-box').style.display = 'flex';
      document.getElementById('cat-all-daily-box').style.display = '';
    }

    // ==================== æŠ˜å /å±•å¼€"å…¶ä»–"ç±»åˆ« ====================
    window.toggleOtherCategory = function() {
      const otherRows = document.querySelectorAll('.other-row');
      const icon = document.getElementById('otherCollapseIcon');

      otherRows.forEach(row => {
        row.classList.toggle('collapsed');
      });

      icon.classList.toggle('expanded');
    }

    // ==================== æŠ˜å /å±•å¼€å•ä¸ªSKUçš„å°ºç è¡Œ ====================
    window.toggleSkuRow = function(skuId) {
      const sizeRows = document.querySelectorAll(`.${skuId}-size`);
      const icon = document.getElementById(`${skuId}_icon`);

      sizeRows.forEach(row => {
        row.classList.toggle('collapsed');
      });

      icon.classList.toggle('expanded');
    }

    // ==================== æ˜¾ç¤ºä½åº“å­˜SKUå¼¹çª— ====================
    window.showLowStockModal = function() {
      const lowStockData = allData.filter(row => {
        const threshold = row.shipQty * 0.1;
        return row.stock < threshold && threshold > 0;
      });

      if (lowStockData.length === 0) {
        alert('æš‚æ— ä½åº“å­˜é¢„è­¦æ•°æ®');
        return;
      }

      // æŒ‰åº“å­˜ä»ä½åˆ°é«˜æ’åº
      lowStockData.sort((a, b) => a.stock - b.stock);

      let html = `
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
            <thead style="background: #f1f5f9; position: sticky; top: 0;">
              <tr>
                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #cbd5e1;">å“ç±»</th>
                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #cbd5e1;">SKU</th>
                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #cbd5e1;">å°ºç </th>
                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #cbd5e1;">å•†å“åç§°</th>
                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #cbd5e1;">åº“å­˜</th>
                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #cbd5e1;">å‡ºè´§æ•°</th>
                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #cbd5e1;">é¢„è­¦é˜ˆå€¼</th>
              </tr>
            </thead>
            <tbody>
      `;

      lowStockData.forEach(row => {
        const threshold = Math.round(row.shipQty * 0.1);
        html += `
          <tr style="border-bottom: 1px solid #e5e7eb;">
            <td style="padding: 8px; text-align: center;"><strong>${row.category}</strong></td>
            <td style="padding: 8px; text-align: center;">${row.sku}</td>
            <td style="padding: 8px; text-align: center;">${row.size || '-'}</td>
            <td style="padding: 8px; text-align: center;">${row.productName || '-'}</td>
            <td style="padding: 8px; text-align: center; color: #ea580c; font-weight: bold;">${Math.round(row.stock)}</td>
            <td style="padding: 8px; text-align: center;">${Math.round(row.shipQty)}</td>
            <td style="padding: 8px; text-align: center;">${threshold}</td>
          </tr>
        `;
      });

      html += '</tbody></table></div>';

      showModal(`ä½åº“å­˜SKUæ˜ç»†ï¼ˆå…±${lowStockData.length}ä¸ªï¼‰`, html);
    }

    // ==================== æ˜¾ç¤ºé¢„è­¦å“ç±»å¼¹çª— ====================
    window.showWarningCategoriesModal = function() {
      const lowStockData = allData.filter(row => {
        const threshold = row.shipQty * 0.1;
        return row.stock < threshold && threshold > 0;
      });

      if (lowStockData.length === 0) {
        alert('æš‚æ— é¢„è­¦å“ç±»æ•°æ®');
        return;
      }

      // æŒ‰å“ç±»ç»Ÿè®¡
      const categoryStats = {};
      lowStockData.forEach(row => {
        if (!categoryStats[row.category]) {
          categoryStats[row.category] = {
            count: 0,
            totalStock: 0,
            items: []
          };
        }
        categoryStats[row.category].count++;
        categoryStats[row.category].totalStock += row.stock;
        categoryStats[row.category].items.push(row);
      });

      let html = '<div style="display: flex; flex-direction: column; gap: 20px;">';

      Object.keys(categoryStats).sort().forEach((cat, index) => {
        const stats = categoryStats[cat];

        // ä¸ºä¸åŒå“ç±»ä½¿ç”¨ä¸åŒçš„æ¸å˜é…è‰²
        const gradients = [
          {
            bg: 'linear-gradient(135deg, rgba(99, 102, 241, 0.08) 0%, rgba(168, 85, 247, 0.05) 100%)',
            border: 'linear-gradient(135deg, #6366f1 0%, #a855f7 100%)',
            accent: '#6366f1'
          },
          {
            bg: 'linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(14, 165, 233, 0.05) 100%)',
            border: 'linear-gradient(135deg, #3b82f6 0%, #0ea5e9 100%)',
            accent: '#3b82f6'
          },
          {
            bg: 'linear-gradient(135deg, rgba(236, 72, 153, 0.08) 0%, rgba(168, 85, 247, 0.05) 100%)',
            border: 'linear-gradient(135deg, #ec4899 0%, #a855f7 100%)',
            accent: '#ec4899'
          }
        ];

        const theme = gradients[index % gradients.length];

        html += `
          <div style="
            background: ${theme.bg};
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 16px;
            padding: 24px;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease;
          ">
            <!-- å·¦ä¾§è£…é¥°æ¡ -->
            <div style="
              position: absolute;
              left: 0;
              top: 0;
              bottom: 0;
              width: 5px;
              background: ${theme.border};
              border-radius: 16px 0 0 16px;
            "></div>

            <!-- å“ç±»æ ‡é¢˜ -->
            <div style="
              font-size: 1.3em;
              font-weight: 700;
              color: ${theme.accent};
              margin-bottom: 20px;
              padding-left: 8px;
              display: flex;
              align-items: center;
              gap: 10px;
            ">
              <span style="
                display: inline-block;
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: ${theme.border};
              "></span>
              ${cat} å“ç±»
            </div>

            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div style="
              display: grid;
              grid-template-columns: repeat(3, 1fr);
              gap: 16px;
            ">
              <div style="
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.7) 100%);
                border-radius: 12px;
                padding: 20px 16px;
                text-align: center;
                border: 1px solid rgba(148, 163, 184, 0.1);
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
                transition: transform 0.2s ease;
              " onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0)'">
                <div style="
                  color: #64748b;
                  font-size: 0.8em;
                  font-weight: 600;
                  margin-bottom: 10px;
                  text-transform: uppercase;
                  letter-spacing: 0.5px;
                ">ä½åº“å­˜SKUæ•°</div>
                <div style="
                  background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
                  -webkit-background-clip: text;
                  -webkit-text-fill-color: transparent;
                  background-clip: text;
                  font-size: 2em;
                  font-weight: 800;
                ">${stats.count}</div>
              </div>

              <div style="
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.7) 100%);
                border-radius: 12px;
                padding: 20px 16px;
                text-align: center;
                border: 1px solid rgba(148, 163, 184, 0.1);
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
                transition: transform 0.2s ease;
              " onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0)'">
                <div style="
                  color: #64748b;
                  font-size: 0.8em;
                  font-weight: 600;
                  margin-bottom: 10px;
                  text-transform: uppercase;
                  letter-spacing: 0.5px;
                ">æ€»åº“å­˜</div>
                <div style="
                  background: linear-gradient(135deg, ${theme.accent} 0%, #2563eb 100%);
                  -webkit-background-clip: text;
                  -webkit-text-fill-color: transparent;
                  background-clip: text;
                  font-size: 2em;
                  font-weight: 800;
                ">${Math.round(stats.totalStock)}</div>
              </div>

              <div style="
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.7) 100%);
                border-radius: 12px;
                padding: 20px 16px;
                text-align: center;
                border: 1px solid rgba(148, 163, 184, 0.1);
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
                transition: transform 0.2s ease;
              " onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0)'">
                <div style="
                  color: #64748b;
                  font-size: 0.8em;
                  font-weight: 600;
                  margin-bottom: 10px;
                  text-transform: uppercase;
                  letter-spacing: 0.5px;
                ">å¹³å‡åº“å­˜</div>
                <div style="
                  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                  -webkit-background-clip: text;
                  -webkit-text-fill-color: transparent;
                  background-clip: text;
                  font-size: 2em;
                  font-weight: 800;
                ">${Math.round(stats.totalStock / stats.count)}</div>
              </div>
            </div>
          </div>
        `;
      });

      html += '</div>';

      showModal(`é¢„è­¦å“ç±»ç»Ÿè®¡ï¼ˆå…±${Object.keys(categoryStats).length}ä¸ªå“ç±»ï¼‰`, html);
    }

    // ==================== æ˜¾ç¤ºå¼¹çª— ====================
    function showModal(title, content) {
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalBody').innerHTML = content;
      document.getElementById('modal').classList.add('show');
    }

    // ==================== å…³é—­å¼¹çª— ====================
    window.closeModal = function() {
      document.getElementById('modal').classList.remove('show');
    }

    // ==================== ç‚¹å‡»èƒŒæ™¯å…³é—­å¼¹çª— ====================
    window.closeModalOnBackdrop = function(event) {
      if (event.target.id === 'modal') {
        closeModal();
      }
    }

    // ==================== å¯¼å‡ºé¡µé¢ä¸ºå›¾ç‰‡ ====================
    window.exportPageAsImage = function() {
      const button = event.target;
      button.textContent = 'ç”Ÿæˆä¸­...';
      button.disabled = true;

      // åªå¯¼å‡ºreportBodyéƒ¨åˆ†ï¼Œä¸åŒ…æ‹¬ä¸Šä¼ æ¨¡å—
      const reportBody = document.getElementById('reportBody');

      if (!reportBody || reportBody.style.display === 'none') {
        alert('è¯·å…ˆä¸Šä¼ Excelæ–‡ä»¶ç”ŸæˆæŠ¥è¡¨');
        button.textContent = 'ğŸ“¸ å¯¼å‡ºå›¾ç‰‡';
        button.disabled = false;
        return;
      }

      // ä½¿ç”¨html2canvasæˆªå›¾reportBody
      html2canvas(reportBody, {
        scale: 2,
        useCORS: true,
        backgroundColor: '#f8fafc',
        logging: false,
        width: reportBody.scrollWidth,
        height: reportBody.scrollHeight
      }).then(canvas => {
        // åˆ›å»ºä¸‹è½½é“¾æ¥
        const link = document.createElement('a');
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
        link.download = `è·¨å¢ƒåº“å­˜åˆ†ææŠ¥è¡¨_${timestamp}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();

        button.textContent = 'ğŸ“¸ å¯¼å‡ºå›¾ç‰‡';
        button.disabled = false;
      }).catch(err => {
        console.error('å¯¼å‡ºå¤±è´¥:', err);
        alert('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
        button.textContent = 'ğŸ“¸ å¯¼å‡ºå›¾ç‰‡';
        button.disabled = false;
      });
    }

    // å›¾ç‰‡åŒ¹é…æ¦‚è§ˆ/ç¼ºå›¾å¯¼å‡ºæ¨¡å—å·²ç§»é™¤

    // è¦†ç›–JSONåŠŸèƒ½åœ¨WPSæ¨¡å¼éœ€æ±‚ä¸­å·²ç§»é™¤
  </script>
  <script>
    // ===== è¿‘ä¸‰æ—¥æ–‡ä»¶è‡ªåŠ¨å‘ç°ä¸åŠ è½½ =====
    function fmtYMD(d){const y=d.getFullYear();const m=String(d.getMonth()+1).padStart(2,'0');const dd=String(d.getDate()).padStart(2,'0');return `${y}${m}${dd}`}
    function fmtDisplay(dstr){return `${dstr.slice(0,4)}/${parseInt(dstr.slice(4,6))}/${parseInt(dstr.slice(6,8))}`}
    function getRecent(n=3){const t=new Date();return Array.from({length:n},(_,i)=>{const d=new Date(t);d.setDate(t.getDate()-i);return fmtYMD(d)});}
    async function headExists(url){try{const r=await fetch(url,{method:'HEAD',cache:'no-store'});if(r.ok)return true;const r2=await fetch(url,{method:'GET',cache:'no-store'});return r2.ok;}catch(e){return false}}
    function setProgress(i,total){const text=document.getElementById('progressText');const bar=document.getElementById('progressBar');if(text) text.textContent=`æ­£åœ¨æŸ¥æ‰¾è¿‘ä¸‰æ—¥æŠ¥è¡¨â€¦ (${i}/${total})`; if(bar) bar.style.width=`${Math.round((i/total)*100)}%`;}
    function showProgress(show){const box=document.getElementById('progressBox'); if(box) box.style.display= show? '' : 'none';}
    async function discoverRecent(){
      const dates=getRecent(3);
      const results=[];
      showProgress(true);
      for(let idx=0; idx<dates.length; idx++){
        const ds = dates[idx];
        setProgress(idx, dates.length);
        const name=`åº“å­˜æŠ¥è¡¨_merge_${ds}.xlsx`;
        const bases=['./source/','../source/','/source/'];
        let foundUrl=null;
        for(const b of bases){
          const u=new URL(b+name, location.href).href;
          if(await headExists(u)){foundUrl=u;break;}
        }
        if(foundUrl) results.push({ds,name,url:foundUrl});
      }
      setProgress(dates.length, dates.length);
      setTimeout(()=>showProgress(false),300);
      return results;
    }
    async function loadDateFile(entry){try{const resp=await fetch(entry.url,{cache:'no-store'});if(!resp.ok)throw new Error('æ–‡ä»¶è·å–å¤±è´¥');const buf=await resp.arrayBuffer();const file=new File([buf], entry.name,{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}); await handleFile(file);}catch(e){alert(`åŠ è½½å¤±è´¥ï¼š${e.message}`)} }
    function renderDateButtons(files){const box=document.getElementById('date-picker');box.innerHTML='';if(!files.length){box.innerHTML='<span style="color:#94a3b8">è¿‘ä¸‰æ—¥æš‚æ— å¯ç”¨æ•°æ®</span>';return}const today=fmtYMD(new Date());files.forEach(f=>{const btn=document.createElement('button');btn.className='date-btn'+(f.ds===today?' date-btn--primary':'');btn.textContent=fmtDisplay(f.ds);btn.onclick=()=>loadDateFile(f);box.appendChild(btn);});}
    document.addEventListener('DOMContentLoaded', async()=>{
      // è‹¥é€šè¿‡ file:// æ‰“å¼€ï¼Œæµè§ˆå™¨å°†å› å®‰å…¨ç­–ç•¥æ‹’ç»è·¨æºè¯»å–æœ¬åœ°æ–‡ä»¶
      if (location.protocol === 'file:') {
        const box = document.getElementById('date-picker');
        if (box) {
          box.innerHTML = '<span style="color:#ef4444">å½“å‰ä»¥ file:// æ–¹å¼æ‰“å¼€ï¼Œæµè§ˆå™¨ç¦æ­¢è¯»å–æœ¬åœ°æ–‡ä»¶ã€‚è¯·ä½¿ç”¨æœ¬åœ°æœåŠ¡å™¨ï¼ˆä¾‹å¦‚ï¼špython -m http.server æˆ– VSCode Live Serverï¼‰æˆ–éƒ¨ç½²åˆ° Netlify åå†è¯•ã€‚</span>';
        }
        return;
      }
      try {
        const files = await discoverRecent();
        renderDateButtons(files);
      } catch(e) {
        console.warn('è‡ªåŠ¨å‘ç°å¤±è´¥', e);
      }
    });
  </script>
</body>
</html>

